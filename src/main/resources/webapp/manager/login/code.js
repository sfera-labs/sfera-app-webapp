(function(){var root=this;var Sfera=Sfera||{VERSION:"0.1.0",client:null};Sfera.Compiler=new function(){function getComments(context){var foundComments=[];var elementPath=[context];while(elementPath.length>0){var el=elementPath.pop();for(var i=0;i<el.childNodes.length;i++){var node=el.childNodes[i];if(node.nodeType===8){foundComments.push(node)}else{elementPath.push(node)}}}return foundComments}this.createComponent=function(name,attributes){var component=Sfera.Components.createInstance(name,attributes);return component};this.compileXMLNode=function(xmlNode,options){if(xmlNode.nodeType==1){options=options||{};options.index=options.index||true;var i,a;var attrs={};for(i=0;i<xmlNode.attributes.length;i++){a=xmlNode.attributes[i];attrs[Sfera.Utils.dashToCamel(a.name)]=a.value}if(options.idPrefix&&attrs.id)attrs.id=options.idPrefix+"."+attrs.id;var component=this.createComponent(xmlNode.nodeName,attrs);if(component){if(options.index)Sfera.client.indexComponent(component);var child;var c=xmlNode.childNodes;for(i=0;i<c.length;i++){child=this.compileXMLNode(c[i]);if(child)component.addChild(child)}}return component}return null};this.compileXML=function(xmlDoc,options){return this.compileXMLNode(xmlDoc.documentElement,options)};this.compileString=function(xmlStr){parser=new DOMParser;xmlDoc=parser.parseFromString(txt,"text/xml");this.compileXML(xmlDoc)};this.compileDictionary=function(xmlDoc){var xmlNode=xmlDoc.documentElement;if(xmlNode&&xmlNode.nodeType==1){var c=xmlNode.childNodes,c2,c3,n,i,t,k;for(i=0;i<c.length;i++){if(c[i].nodeType==1)switch(c[i].tagName){case"skin":break;case"components":c2=c[i].childNodes;for(t=0;t<c2.length;t++){if(c2[t].nodeType==1){c3=c2[t].childNodes;for(k=0;k<c3.length;k++){switch(c3[k].tagName){case"src":Sfera.Components.setSource(c2[t].tagName,Sfera.Utils.getCDATA(c3[k]));break;case"_lan":Sfera.Components.setLanguage(c2[t].tagName,Sfera.Utils.getCDATA(c3[k]));break}}}}break}}}};this.compileHTML=function(source){source=source.replace(/\$interface\;/g,Sfera.client.name);return source};this.getMustacheData=function(source){if(!Sfera.Utils.isString(source)||source.indexOf("{")==-1)return null;var data={vars:[]};var MUSTACHE=/\{\{([^}]*)\}\}/g;var m;while(m=MUSTACHE.exec(source)){data.vars.push(m[1])}if(!data.vars.length)return null;return data};this.compileAttributeValue=function(attr,source){var str;var MUSTACHE=/\{\{([^}]*)\}\}/g;var value=source||attr.source;if(attr.mustache){function rep(match,capture){return Sfera.client.getNodeValue(capture)}value=value.replace(MUSTACHE,rep)}switch(attr.type){case"integer":value=parseInt(value);break;case"float":value=parseFloat(value);break;case"color":value=value.toLowerCase();names=["aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","green","greenyellow","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgreen","lightgrey","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen"];break;case"string":case"js":if(typeof value!="string"&&value.toString){var v=value.toString();if(v=="[object Object]")value=JSON.stringify(value);else value=v}break;case"boolean":value=!(value==="false"||value===false||value===undefined||value===null);break;case"regexp":try{value=new RegExp(value)}catch(err){value=null}break;case"list":value=value.split(",");break}return value}};Sfera.Attribute=function(component,config){this.type="string";this.changed=false;this.default=null;this.source=null;this.value=null;this.required=false;this.values=null;this.component=component;for(var c in config){switch(c){case"type":case"source":case"value":case"default":this[c]=config[c];break;case"set":case"get":case"compile":case"update":case"post":this[c]=config[c].bind(this);break;case"values":if(Sfera.Utils.isFunction(config[c]))this[c]=config[c].bind(this);else this[c]=config[c];break}}};Sfera.Attribute.prototype={set:function(value,manualUpdate){if(this.source===value)return;this.changed=true;this.source=value;var mustache=Sfera.Compiler.getMustacheData(value);var eq=this.mustache&&mustache&&this.mustache.vars.equals(mustache.vars);if(this.mustache&&!eq){for(var i=0;i<this.mustache.vars.length;i++)Sfera.client.removeAttrObserver(this.mustache.vars[i],this)}this.mustache=mustache;if(this.mustache&&!eq){for(var i=0;i<this.mustache.vars.length;i++)Sfera.client.bindAttrObserver(this.mustache.vars[i],this)}if(!manualUpdate)this.compile()},get:function(){return this.value},compile:function(){var value=Sfera.Compiler.compileAttributeValue(this);if(this.values){if(Sfera.Utils.isFunction(this.values))arr=this.values();else arr=this.values;if(Sfera.Utils.isArray(arr)){if(arr.indexOf(value)==-1)return}}if(value!==this.value){this.changed=false;this.value=value;this.update()}},update:function(){this.post()},post:function(){}};Sfera.ComponentManager=function(client){this.client=client;var all=[];var byId={};var byGroup={};var byType={};function addBy(co,set,value){if(!set[value])set[value]=[];set[value].push(co)}function removeBy(co,set,value){for(var i=0;i<set[value].length;i++){if(set[value]==co){set[value]=null;delete set[value];return}}}function getBy(arr,value){return arr[value]?arr[value]:[]}this.index=function(co){all.push(co);addBy(co,byType,co.type);if(co.id)addBy(co,byId,co.id);if(co.group)addBy(co,byGroup,co.group)};this.addByGroup=function(co,group){addBy(co,byGroup,group)};this.removeByGroup=function(co,group){removeBy(co,byGroup,group)};this.getFirstById=function(id){return this.getById(id)[0]};this.getById=function(id){return getBy(byId,id)};this.getByType=function(type){return getBy(byType,type)};this.getByGroup=function(group){return getBy(byGroup,group)};this.getValue=function(id){var co=this.getFirstById(id);return co?co.getAttribute("value"):null}};Sfera.ComponentPresets={};Sfera.ComponentPresets.Visibility=function(){this.attrDefs.visible={type:"boolean",compile:function(){var value=!(!this.source||this.source=="false");if(value!==this.value){this.changed=false;this.value=value;this.update()}},update:function(){function trigger(co,show,child){if(!child||co.getAttribute("visible")){if(show&&co.onShow){co.onShow()}else if(!show&&co.onHide){co.onHide()}if(co.children){for(var c=0;c<co.children.length;c++)trigger(co.children[c],show)}}}if(!this.value){trigger(this.component,false)}this.component.element.style.display=this.value?"inline":"none";if(this.value){trigger(this.component,true)}this.post()}}};Sfera.ComponentPresets.Position=function(){this.attrDefs.position={type:"string",update:function(){this.component.element.style.position=this.value=="static"?"static":"absolute";this.post()}};this.attrDefs.x={type:"integer",update:function(){this.component.element.style.left=this.value+"px";this.post()}};this.attrDefs.y={type:"integer",update:function(){this.component.element.style.top=this.value+"px";this.post()}};this.attrDefs.rotation={type:"integer",update:function(){var s=this.component.element.style;var r="rotate("+this.value+"deg)";s.msTransform=s.webkitTransform=s.transform=r;this.post()}}};Sfera.ComponentPresets.Size=function(){this.attrDefs.width={type:"integer",update:function(){this.component.element.style.width=this.value=="auto"?"auto":this.value+"px";this.post()}};this.attrDefs.height={type:"integer",update:function(){this.component.element.style.height=this.value=="auto"?"auto":this.value+"px";this.post()}}};Sfera.ComponentPresets.Label=function(){this.attrDefs.label={type:"string",update:function(){this.component.element.innerHTML=this.value;this.post()}};this.attrDefs.color={type:"string",update:function(){this.component.element.style.color=this.value;this.post()}};this.attrDefs.fontSize={type:"integer",update:function(){this.component.element.style.fontSize=this.value+"px";this.post()}};this.attrDefs.textAlign={type:"string",update:function(){this.component.element.style.textAlign=this.value;this.post()}}};Sfera.ComponentPresets.Style=function(){this.attrDefs.style={type:"string","default":"default",values:function(){var s=Sfera.client.skin.styles[this.component.type];return s?s:["default"]},update:function(){if(this.component.updateClass)this.component.updateClass();this.post()}}};Sfera.ComponentPresets.Color=function(){this.attrDefs.color={type:"string","default":"default",values:function(){var c=Sfera.client.skin.colors[this.component.type];return c?c:["default"]},update:function(){if(this.component.updateClass)this.component.updateClass();this.post()}}};Sfera.Components=new function(){this._createLater={};this.setSource=function(componentName,source){var cc=this.getClass(componentName);cc.prototype.source=source};this.bakeSource=function(componentName){var cc=this.getClass(componentName);var d=document.createElement("div");d.innerHTML=Sfera.Compiler.compileHTML(cc.prototype.source);var dom=Sfera.Utils.getFirstChildNodeOfType(d,1);dom.setAttribute("data-controller",componentName);cc.prototype.dom=dom;cc.prototype.source=null};this.getClassName=function(componentName){return Sfera.Utils.capitalize(Sfera.Utils.dashToCamel(componentName))};this.getClass=function(componentName){return Sfera.Components[this.getClassName(componentName)]};this.createInstance=function(componentName,attributes){var cc=this.getClass(componentName);if(cc==null)return null;var component=new cc({attributes:attributes});return component};this.create=function(name,def){if(def.extends&&!Sfera.Components[def.extends]){if(!this._createLater[def.extends])this._createLater[def.extends]=[];this._createLater[def.extends].push({name:name,def:def});return}Sfera.Components[name]=function Component(def){this.children=[];if(def.element){this.element=element}else{if(this.source)Sfera.Components.bakeSource(name);if(this.dom){this.element=this.dom.cloneNode(true);this.element.controller=this;this.subComponents={};var nodes=Sfera.Utils.getAllCommentChildNodes(this.element);var xml;this.id=def.attributes?def.attributes.id:null;for(var i=0;i<nodes.length;i++){if(nodes[i].nodeValue.substr(0,3)=="sml"){xml=Sfera.Utils.parseXML(nodes[i].nodeValue.substr(3));var root=Sfera.Compiler.compileXML(xml,{index:this.id?true:false,idPrefix:this.id});if(root&&root.element){nodes[i].parentNode.replaceChild(root.element,nodes[i]);this.addSubComponent(root)}}}}}this.attributes={};for(var attr in this.attrDefs){this.attributes[attr]=new Sfera.Attribute(this,this.attrDefs[attr])}this.super("_Base","init");this.init();for(var attr in this.attributes){if(def.attributes&&def.attributes[attr]!=null)this.setAttribute(attr,def.attributes[attr]);else if(this.attributes[attr].default!=null)this.setAttribute(attr,this.attributes[attr].default)}};var comp=Sfera.Components[name];comp.displayName="Sfera.Component."+name;if(!def.extends)def.extends="_Base";var sup=Sfera.Components[def.extends].prototype;comp.prototype=Object.create(sup);comp.prototype.constructor=comp;comp.prototype.type=name;comp.prototype.attrDefs={};for(var a in sup.attrDefs){comp.prototype.attrDefs[a]=sup.attrDefs[a]}if(def.presets){var be;for(var i=0;i<def.presets.length;i++){be=Sfera.ComponentPresets[def.presets[i]];be.call(comp.prototype)}}if(def.attributes){for(var attr in def.attributes){if(!comp.prototype.attrDefs[attr]){comp.prototype.attrDefs[attr]=def.attributes[attr]}else{if(comp.prototype.attrDefs[attr]==sup.attrDefs[attr]){comp.prototype.attrDefs[attr]=Object.create(sup.attrDefs[attr])}for(var i in def.attributes[attr]){comp.prototype.attrDefs[attr][i]=def.attributes[attr][i]}}}}for(var f in def){if(f=="presets"||f=="attributes")continue;comp.prototype[f]=def[f];if(typeof comp.prototype[f]==="function")comp.prototype[f].displayName="Sfera.Components."+name+"."+f}if(this._createLater[name]){for(var i=0;i<this._createLater[name].length;i++){var c=this._createLater[name][i];this.create(c.name,c.def)}delete this._createLater[name]}}};Sfera.Client=function(config){Sfera.client=this;if(!config)config={};this.name="";this.isLogin=false;this.isBooted=false;this.isRunning=false;this.components=null;this.input=null;this.debug=null;var paused=false;this.cPage=null;var manifestTimestamp=0;var self=this;this.interface="";this.skin=null;var interfaceC;this.boot=function(url){if(this.isBooted)return;var location=Sfera.Browser.getLocation();this.name=location.interface;this.isLogin=location.login;if(config.timestamp)manifestTimestamp=config.timestamp;Sfera.client=this;this.isBooted=true;this.components=new Sfera.ComponentManager(this);this.name=config.interface;if(true||this.config.enableDebug){this.debug=Sfera.Debug;this.debug.boot()}else{}if(window.focus){window.focus()}Sfera.Debug.showHeader();Sfera.Net.onReply.add(onReply);Sfera.Net.onEvent.add(onEvent);Sfera.Net.onUpdateDictionary.add(onUpdateDictionary);Sfera.Net.onUpdateIndex.add(onUpdateIndex);Sfera.Net.connect();window.onresize=adjustLayout;window.onkeydown=onKeyDown;window.onkeyup=onKeyUp;window.onkeypress=onKeyPress;delete config};this.destroy=function(){this.input.destroy();this.input=null;this.isBooted=false;Sfera.CLIENTS[this.id]=null};this.openIndex=function(url,onDone){};this.openDictionary=function(url,onDone){};function onReply(json){if(json.result&&json.result.uiSet){for(var u in json.result.uiSet){var n=u.split(".");var a=n.pop();var c=self.components.getById(n.join("."));for(var i=0;i<c.length;i++){c[i].setAttribute(a,json.result.uiSet[u])}}}}function onUpdateDictionary(xmlDoc){var root=Sfera.Compiler.compileDictionary(xmlDoc)}function onUpdateIndex(xmlDoc){var root=Sfera.Compiler.compileXML(xmlDoc);document.getElementById("sfera").appendChild(root.element);self.start()}this.start=function(){Sfera.Browser.start();interfaceC=this.components.getByType("Interface")[0];adjustLayout()};this.indexComponent=function(component){this.components.index(component)};this.setAttribute=function(id,name,value){var c=this.components.getById(id);for(var i=0;i<c.length;i++)c[i].setAttribute(name,value)};this.getAttribute=function(id,name){var c=this.components.getFirstById(id);return c.getAttribute(name)};this.showPage=function(id){if(id.indexOf(":")==-1)id="page:"+id;if(this.cPage)this.cPage.setAttribute("visible",false);var p=this.components.getFirstById(id);if(p){p.setAttribute("visible",true);this.cPage=p;Sfera.Browser.updateUrl(id,p.getAttribute("title"))}else{console.log("page not found: "+id)}};var commandQueue=[];this.sendCommand=function(command,callback){var tag=(new Date).getTime();var req={command:command,tag:tag,callback:callback};commandQueue.push(req);Sfera.Net.sendCommand(req);return tag};var eventQueue=[];this.sendEvent=function(id,value,callback){var tag=(new Date).getTime();var req={id:"webapp.ui."+id,value:value,tag:tag,callback:callback};eventQueue.push(req,callback);Sfera.Net.sendEvent(req);return tag};var nodeValues={};this.getNodeValue=function(node){return nodeValues[node]?nodeValues[node]:""};function onEvent(json){for(var e in json.nodes){var n=e.split(".");switch(n[0]){case"ui":if(n[1]=="set"){n=n.slice(3);var a=n.pop();var c=self.components.getById(n.join("."));for(var i=0;i<c.length;i++){c[i].setAttribute(a,json.nodes[e])}}break;case"webapp":if(n[1]=="interface"&&n[2]==self.name&&n[3]=="update"){if(json.nodes[e]!=manifestTimestamp){manifestTimestamp=json.nodes[e];Sfera.Browser.reload()}}break}nodeValues[e]=json.nodes[e];if(attrObservers[e])attrObservers[e].dispatch()}}function adjustLayout(){if(!interfaceC)return;var width=parseInt(interfaceC.getAttribute("width"));var height=parseInt(interfaceC.getAttribute("height"));var viewportWidth;var viewportHeight;if(window.innerWidth){viewportWidth=window.innerWidth;viewportHeight=window.innerHeight}else if(document.documentElement&&document.documentElement.clientWidth){viewportWidth=document.documentElement.clientWidth;viewportHeight=document.documentElement.clientHeight}else if(document.body.clientWidth){viewportWidth=document.body.clientWidth;viewportHeight=document.body.clientHeight}else{viewportWidth=0;viewportHeight=0}if(viewportWidth>0){var left=viewportWidth>width?(viewportWidth-width)/2:0;var top=viewportHeight>height?(viewportHeight-height)/2:0;interfaceC.element.style.display="none";interfaceC.element.style.left=left+"px";interfaceC.element.style.top=top+"px";interfaceC.element.style.display="block"}}var attrObservers={};this.bindAttrObserver=function(node,attribute){if(!attrObservers[node])attrObservers[node]=new Sfera.Signal;attrObservers[node].addOnce(attribute.compile,attribute)};this.removeAttrObserver=function(node,attribute){attrObservers[node].remove(attribute.compile,attribute)};function onKeyDown(event){var evt=event||window.event;var code=evt.charCode||evt.keyCode;self.ctrlKey=evt.ctrlKey;self.shiftKey=evt.shiftKey;if(focusedCo&&focusedCo.onKeyDown){if(!focusedCo.onKeyDown(evt,code)){Sfera.Browser.preventDefault(evt);return false}}else{if(code==9){if(self.cPage.children.length)focusFirst(self.cPage,evt.shiftKey);Sfera.Browser.preventDefault(evt);return false}}return true}function onKeyPress(event){var evt=event||window.event;var code=evt.charCode||evt.keyCode;self.ctrlKey=evt.ctrlKey;self.shiftKey=evt.shiftKey;if(focusedCo&&focusedCo.onKeyPress){if(!focusedCo.onKeyPress(evt,code)){Sfera.Browser.preventDefault(evt);return false}}return true}function onKeyUp(event){var evt=event||window.event;var code=evt.charCode||evt.keyCode;self.ctrlKey=evt.ctrlKey;self.shiftKey=evt.shiftKey;if(focusedCo&&focusedCo.onKeyUp){if(focusedCo.onKeyUp(evt,code))return true}Sfera.Browser.preventDefault(evt);return false}var focusedCo;var blurTimeoutId;this.setFocused=function(co){if(focusedCo&&focusedCo!=co)focusedCo.blur();focusedCo=co;if(blurTimeoutId)clearTimeout(blurTimeoutId);if(!co.noBlurTimeout)blurTimeoutId=setTimeout(this.focus,3e4)};this.clearFocused=function(co){if(focusedCo==co)focusedCo=null;if(blurTimeoutId)clearTimeout(blurTimeoutId)};this.focus=function(){if(focusedCo)focusedCo.blur()};function canFocus(co){return co!=this&&co.focus&&co.isVisible()&&co.isEnabled()}function focusFirst(container,dir){var l=container.children.length;var co=container.children[dir?l-1:0];if(co.isVisible()){if(co.focus&&co.isEnabled()){co.focus();return co}else if(co.children&&co.children.length){return focusFirst(co,dir)}}return focusNext(co)}function focusNext(co,dir){var cos=co.parent.children;var oi=-1;var i;var r;for(i=0;i<cos.length;i++){if(cos[i]==co){oi=i;break}}if(oi==-1)return null;i=oi;do{if(dir){i--;if(i<0){if(co.parent.parent){r=focusNext(co.parent,dir);if(r)return r}i=cos.length-1}}else{i++;if(i>=cos.length){if(co.parent.parent){r=focusNext(co.parent,dir);if(r)return r}i=0}}if(cos[i].children&&cos[i].children.length){r=focusFirst(cos[i],dir);if(r)return r}if(canFocus(cos[i])){cos[i].focus();return cos[i]}}while(cos[i]!=co);return null}this.focusNext=function(dir){return focusNext(focusedCo,dir)}};Sfera.Debug=new function(){var self=this;var logE,debugE;document.addEventListener("keydown",keyDown,false);this.visible=false;this.boot=function(){logE=document.getElementById("debugLog");debugE=document.getElementById("debug");show(false)};this.toggle=function(){this.visible=!this.visible;show(this.visible)};function show(v){debugE.style.display=v?"block":"none";if(v)self.initPane()}function keyDown(e){var keyCode=e.keyCode;if(keyCode==13){}else if(event.altKey&&event.keyCode>=65&&event.keyCode<=90){switch(String.fromCharCode(event.keyCode)){case"D":self.toggle();break}}else{}return true}var logCounter=0;this.log=function(level,title,txt){if(!logE)return;logCounter++;var ds=Sfera.Utils.getDate();title=ds+" - "+title;var src='<label class="menu_label" for="debugEntry'+logCounter+'">'+title+"</label>"+'<input type="checkbox" id="debugEntry'+logCounter+'" /><div class="arrow"></div>'+'<ol><li><textarea style="width:500px; height:200px">'+txt+"</textarea></li></ol>";var e=document.createElement("div");e.innerHTML=src;logE.appendChild(e)};this.showHeader=function(){var v=Sfera.VERSION;var c=2;var a="hello";if(Sfera.Device.chrome){var args=["%c %c %c Sfera v"+v+" | "+a+"  %c %c "+"%c http://sfera.cc %c♥%c♥%c♥","background: #9854d8","background: #6c2ca7","color: #ffffff; background: #450f78;","background: #6c2ca7","background: #9854d8","background: #ffffff"];for(var i=0;i<3;i++){if(i<c){args.push("color: #ff2424; background: #fff")}else{args.push("color: #959595; background: #fff")}}console.log.apply(console,args)}else if(window.console){console.log("Sfera v"+v+" | "+a+" | http://sferalabs.cc")}}};Sfera.Debug.initPane=function(){var minWidth=60;var minHeight=40;var FULLSCREEN_MARGINS=-10;var MARGINS=10;var clicked=null;var onRightEdge,onBottomEdge,onLeftEdge,onTopEdge;var rightScreenEdge,bottomScreenEdge;var preSnapped;var b,x,y;var redraw=false;var pane=document.getElementById("debugPane");var paneTitle=document.getElementById("debugTitle");var ghostpane=document.getElementById("debugGhost");paneTitle.style.width=pane.style.width;function setBounds(element,x,y,w,h){element.style.left=x+"px";element.style.top=y+"px";element.style.width=w+"px";element.style.height=h+"px"}function hintHide(){setBounds(ghostpane,b.left,b.top,b.width,b.height);ghostpane.style.opacity=0}pane.addEventListener("mousedown",onMouseDown);document.addEventListener("mousemove",onMove);document.addEventListener("mouseup",onUp);pane.addEventListener("touchstart",onTouchDown);document.addEventListener("touchmove",onTouchMove);document.addEventListener("touchend",onTouchEnd);function onTouchDown(e){onDown(e.touches[0]);e.preventDefault()}function onTouchMove(e){onMove(e.touches[0])}function onTouchEnd(e){if(e.touches.length==0)onUp(e.changedTouches[0])}function onMouseDown(e){onDown(e);e.preventDefault()}function onDown(e){calc(e);var isResizing=onRightEdge||onBottomEdge||onTopEdge||onLeftEdge;clicked={x:x,y:y,cx:e.clientX,cy:e.clientY,w:b.width,h:b.height,isResizing:isResizing,isMoving:!isResizing&&canMove(),onTopEdge:onTopEdge,onLeftEdge:onLeftEdge,onRightEdge:onRightEdge,onBottomEdge:onBottomEdge}}function canMove(){return x>0&&x<b.width&&y>0&&y<b.height&&y<30}function calc(e){b=pane.getBoundingClientRect();x=e.clientX-b.left;y=e.clientY-b.top;onTopEdge=y<MARGINS;onLeftEdge=x<MARGINS;onRightEdge=x>=b.width-MARGINS;onBottomEdge=y>=b.height-MARGINS;rightScreenEdge=window.innerWidth-MARGINS;bottomScreenEdge=window.innerHeight-MARGINS}var e;function onMove(ee){calc(ee);e=ee;redraw=true}function animate(){requestAnimationFrame(animate);if(!redraw)return;redraw=false;if(clicked&&clicked.isResizing){if(clicked.onRightEdge)pane.style.width=Math.max(x,minWidth)+"px";if(clicked.onBottomEdge)pane.style.height=Math.max(y,minHeight)+"px";if(clicked.onLeftEdge){var currentWidth=Math.max(clicked.cx-e.clientX+clicked.w,minWidth);if(currentWidth>minWidth){pane.style.width=currentWidth+"px";pane.style.left=e.clientX+"px"}}if(clicked.onTopEdge){var currentHeight=Math.max(clicked.cy-e.clientY+clicked.h,minHeight);if(currentHeight>minHeight){pane.style.height=currentHeight+"px";pane.style.top=e.clientY+"px"}}hintHide();paneTitle.style.width=pane.style.width;return}if(clicked&&clicked.isMoving){if(b.top<FULLSCREEN_MARGINS||b.left<FULLSCREEN_MARGINS||b.right>window.innerWidth-FULLSCREEN_MARGINS||b.bottom>window.innerHeight-FULLSCREEN_MARGINS){setBounds(ghostpane,0,0,window.innerWidth,window.innerHeight);ghostpane.style.opacity=.2}else if(b.top<MARGINS){setBounds(ghostpane,0,0,window.innerWidth,window.innerHeight/2);ghostpane.style.opacity=.2}else if(b.left<MARGINS){setBounds(ghostpane,0,0,window.innerWidth/2,window.innerHeight);ghostpane.style.opacity=.2}else if(b.right>rightScreenEdge){setBounds(ghostpane,window.innerWidth/2,0,window.innerWidth/2,window.innerHeight);ghostpane.style.opacity=.2}else if(b.bottom>bottomScreenEdge){setBounds(ghostpane,0,window.innerHeight/2,window.innerWidth,window.innerWidth/2);ghostpane.style.opacity=.2}else{hintHide()}if(preSnapped){setBounds(pane,e.clientX-preSnapped.width/2,e.clientY-Math.min(clicked.y,preSnapped.height),preSnapped.width,preSnapped.height);paneTitle.style.width=pane.style.width;return}pane.style.top=e.clientY-clicked.y+"px";pane.style.left=e.clientX-clicked.x+"px";paneTitle.style.width=pane.style.width;return}if(onRightEdge&&onBottomEdge||onLeftEdge&&onTopEdge){pane.style.cursor="nwse-resize"}else if(onRightEdge&&onTopEdge||onBottomEdge&&onLeftEdge){pane.style.cursor="nesw-resize"}else if(onRightEdge||onLeftEdge){pane.style.cursor="ew-resize"}else if(onBottomEdge||onTopEdge){pane.style.cursor="ns-resize"}else if(canMove()){pane.style.cursor="move"}else{pane.style.cursor="default"}}animate();function onUp(e){calc(e);if(clicked&&clicked.isMoving){var snapped={width:b.width,height:b.height};if(b.top<FULLSCREEN_MARGINS||b.left<FULLSCREEN_MARGINS||b.right>window.innerWidth-FULLSCREEN_MARGINS||b.bottom>window.innerHeight-FULLSCREEN_MARGINS){setBounds(pane,0,0,window.innerWidth,window.innerHeight);preSnapped=snapped}else if(b.top<MARGINS){setBounds(pane,0,0,window.innerWidth,window.innerHeight/2);preSnapped=snapped}else if(b.left<MARGINS){setBounds(pane,0,0,window.innerWidth/2,window.innerHeight);preSnapped=snapped}else if(b.right>rightScreenEdge){setBounds(pane,window.innerWidth/2,0,window.innerWidth/2,window.innerHeight);preSnapped=snapped}else if(b.bottom>bottomScreenEdge){setBounds(pane,0,window.innerHeight/2,window.innerWidth,window.innerWidth/2);preSnapped=snapped}else{preSnapped=null}hintHide()}clicked=null}};Sfera.Log=new function(){this.ALL=1;this.DEBUG=2;this.INFO=3;this.WARN=4;this.ERROR=5;this.FATAL=6;this.OFF=7;var _level=this.WARN;this.setLevel=function(level){_level=level}};Sfera.Login=new function(){var checkTimeout=null;var checkMs=500;var req;var action="";this.login=function(user,password){if(!req)initReq();action="login";resetCheck();user=user||Sfera.client.getAttribute("username","value");password=password||Sfera.client.getAttribute("password","value");req.open("/api/login?user="+user+"&password="+password,100)};this.logout=function(){if(!req)initReq();action="logout";req.open("/api/logout",100)};function initReq(){req=new Sfera.Net.Request;req.onLoaded=function(){clearTimeout(checkTimeout);switch(action){case"login":window.location.replace("/"+Sfera.client.name);break;case"logout":window.location.replace("/"+Sfera.client.name+"/login");break}};req.onError=function(){resetCheck()}}function checkLogin(){}function resetCheck(){clearTimeout(checkTimeout);checkTimeout=setTimeout(checkLogin,checkMs)}window.onload=function(){resetCheck()}};Sfera.Signal=function(){};Sfera.Signal.prototype={_bindings:null,_prevParams:null,memorize:false,_shouldPropagate:true,active:true,_boundDispatch:true,validateListener:function(listener,fnName){if(typeof listener!=="function"){throw new Error("Sfera.Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",fnName))}},_registerListener:function(listener,isOnce,listenerContext,priority,args){var prevIndex=this._indexOfListener(listener,listenerContext);var binding;if(prevIndex!==-1){binding=this._bindings[prevIndex];if(binding.isOnce()!==isOnce){throw new Error("You cannot add"+(isOnce?"":"Once")+"() then add"+(!isOnce?"":"Once")+"() the same listener without removing the relationship first.")}}else{binding=new Sfera.SignalBinding(this,listener,isOnce,listenerContext,priority,args);this._addBinding(binding)}if(this.memorize&&this._prevParams){binding.execute(this._prevParams)}return binding},_addBinding:function(binding){if(!this._bindings){this._bindings=[]}var n=this._bindings.length;do{n--}while(this._bindings[n]&&binding._priority<=this._bindings[n]._priority);this._bindings.splice(n+1,0,binding)},_indexOfListener:function(listener,context){if(!this._bindings){return-1}if(context===undefined){context=null}var n=this._bindings.length;var cur;while(n--){cur=this._bindings[n];if(cur._listener===listener&&cur.context===context){return n}}return-1},has:function(listener,context){return this._indexOfListener(listener,context)!==-1},add:function(listener,listenerContext,priority){this.validateListener(listener,"add");var args=[];if(arguments.length>3){for(var i=3;i<arguments.length;i++){args.push(arguments[i])}}return this._registerListener(listener,false,listenerContext,priority,args)},addOnce:function(listener,listenerContext,priority){this.validateListener(listener,"addOnce");var args=[];if(arguments.length>3){for(var i=3;i<arguments.length;i++){args.push(arguments[i])}}return this._registerListener(listener,true,listenerContext,priority,args)},remove:function(listener,context){this.validateListener(listener,"remove");var i=this._indexOfListener(listener,context);if(i!==-1){this._bindings[i]._destroy();this._bindings.splice(i,1)}return listener},removeAll:function(context){if(context===undefined){context=null}if(!this._bindings){return}var n=this._bindings.length;while(n--){if(context){if(this._bindings[n].context===context){this._bindings[n]._destroy();this._bindings.splice(n,1)}}else{this._bindings[n]._destroy()}}if(!context){this._bindings.length=0}},getNumListeners:function(){return this._bindings?this._bindings.length:0},halt:function(){this._shouldPropagate=false},dispatch:function(){if(!this.active||!this._bindings){return}var paramsArr=Array.prototype.slice.call(arguments);var n=this._bindings.length;var bindings;if(this.memorize){this._prevParams=paramsArr}if(!n){return}bindings=this._bindings.slice();this._shouldPropagate=true;do{n--}while(bindings[n]&&this._shouldPropagate&&bindings[n].execute(paramsArr)!==false)},forget:function(){if(this._prevParams){this._prevParams=null}},dispose:function(){this.removeAll();this._bindings=null;if(this._prevParams){this._prevParams=null}},toString:function(){return"[Sfera.Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}};Object.defineProperty(Sfera.Signal.prototype,"boundDispatch",{get:function(){var _this=this;return this._boundDispatch||(this._boundDispatch=function(){return _this.dispatch.apply(_this,arguments)})}});Sfera.Signal.prototype.constructor=Sfera.Signal;Sfera.SignalBinding=function(signal,listener,isOnce,listenerContext,priority,args){this._listener=listener;if(isOnce){this._isOnce=true}if(listenerContext!=null){this.context=listenerContext}this._signal=signal;if(priority){this._priority=priority}if(args&&args.length){this._args=args}};Sfera.SignalBinding.prototype={context:null,_isOnce:false,_priority:0,_args:null,callCount:0,active:true,params:null,execute:function(paramsArr){var handlerReturn,params;if(this.active&&!!this._listener){params=this.params?this.params.concat(paramsArr):paramsArr;if(this._args){params=params.concat(this._args)}handlerReturn=this._listener.apply(this.context,params);this.callCount++;if(this._isOnce){this.detach()}}return handlerReturn},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null;
},isBound:function(){return!!this._signal&&!!this._listener},isOnce:function(){return this._isOnce},getListener:function(){return this._listener},getSignal:function(){return this._signal},_destroy:function(){delete this._signal;delete this._listener;delete this.context},toString:function(){return"[Sfera.SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}};Sfera.SignalBinding.prototype.constructor=Sfera.SignalBinding;var mySingleton=function(){var instance;function init(){function privateMethod(){consolthis.element.log("I am private")}var privateVariable="Im also private";return{publicMethod:function(){consolthis.element.log("The public can see me!")},publicProperty:"I am also public"}}return{getInstance:function(){if(!instance){instance=init()}return instance}}}();var singleA=mySingleton.getInstance();Sfera.UI=new function(){var pressedBt;var lastButton;this.skipButtonEvents=false;this.overEnabled=true;this.buttonFeedbackEnabled=true;this.setPressedButton=function(bt){pressedBt=bt};this.getPressedButton=function(){return pressedBt};this.updateLastButton=function(){lastButton=pressedBt};this.getLastButton=function(){return lastButton};this.liftButton=function(bt){if(pressedBt&&(!bt||bt==pressedBt)){if(pressedBt.data.state){pressedBt.data.state="";pressedBt.updateClass()}if(pressedBt.onLift)pressedBt.onLift();pressedBt=null;return true}return false};this.resetButton=function(bt){if(!this.liftButton(bt)){bt.data.state="";bt.updateClass()}}};Sfera.UI.Button=function(element,events){this.element=element;this.element.btObj=this;this.initData();if(events)this.initEvents(events)};Sfera.UI.Button.prototype={_attributes:{disabled:0,selected:1,pressed:2,checked:3,focused:4,error:5},_linked:null,initData:function(){var colors=["light","stable","positive","calm","balanced","energized","assertive","royal","dark"];var cs=this.element.className;var ss="(.*\\s)?([mc][^\\s]*Button)(\\s("+colors.join("|")+"))?(\\s.*)?(\\sover|\\sdown)?";var rx=new RegExp(ss);var matches=rx.exec(cs);if(!matches||!matches[2])var obj={pre:cs,bc:"",color:"",attrs:[],state:""};else var obj={pre:matches[1]?matches[1]:"",bc:matches[2],color:matches[4]?matches[4]:"",attrs:[],state:matches[6]?matches[6].substr(1):""};for(var a in this._attributes)obj.attrs[this._attributes[a]]=matches&&matches[5]?matches[5].indexOf(" "+a)!=-1:false;this.data=obj;this.onLift=null;this.dontLiftOnMove=false},initEvents:function(f){if(f.onclick)f.onup=f.onclick;if(Sfera.Device.touch){this.element.ontouchstart=this.onEvent.bind(this,"touchstart",f.ondown,null);this.element.ontouchmove=this.onEvent.bind(this,"touchmove",f.onmove,f.onout);this.element.ontouchend=this.onEvent.bind(this,"touchend",f.onup,null)}else{this.element.onmouseover=this.onEvent.bind(this,"mouseover",f.onover,null);this.element.onmouseout=this.onEvent.bind(this,"mouseout",f.onout,null);if(f.onmove)this.element.onmousemove=this.onEvent.bind(this,"mousemove",f.onmove,null);this.element.onmousedown=this.onEvent.bind(this,"mousedown",f.ondown,null);this.element.onmouseup=this.onEvent.bind(this,"mouseup",f.onup,null)}if(f.onlift)this.onLift=f.onlift;if(f.dontLiftOnMove)this.dontLiftOnMove=true;var d},clearEvents:function(){if(Sfera.Device.touch){delete this.element.ontouchstart;delete this.element.ontouchmove;delete this.element.ontouchend}else{delete this.element.onmouseover;delete this.element.onmouseout;delete this.element.onmousedown;delete this.element.onmouseup}},link:function(button){if(!this._linked)this._linked=[];if(!button._linked)button._linked=[];this._linked.push(button);button._linked.push(this)},setColor:function(c){this.data.color=c;this.updateClass()},enable:function(enable){this.setAttribute(this.element,"disabled",!enable)},select:function(select){this.setAttribute(this.element,"selected",select)},mini:function(mini){this.setAttribute(this.element,"mini",mini)},getAttribute:function(attrName){if(!this.data)this.initData();return this.data.attrs[this._attributes[attrName]]},setAttribute:function(attrName,attrValue){if(this.getAttribute(attrName)!=attrValue){this.data.attrs[this._attributes[attrName]]=attrValue;this.updateClass()}},updateClass:function(){var d=this.data;var c=d.pre+d.bc;if(d.color)c+=" "+d.color;for(var a in this._attributes)if(d.attrs[this._attributes[a]])c+=" "+a;if(Sfera.UI.buttonFeedbackEnabled&&d.state)c+=" "+d.state;this.element.className=c},setClassName:function(name){this.data.pre=name;this.updateClass()},disableAndroidLongPress:function(evt,e){if(Sfera.Device.android){var d=e;while(d){if(d.getAttribute&&d.getAttribute("data-scrollmode"))return;d=d.parentNode}evt.preventDefault&&evt.preventDefault();evt.stopPropagation&&evt.stopPropagation();evt.cancelBubble=true;evt.returnValue=false}},preventDefault:function(evt){if(evt.returnValue)evt.returnValue=false;if(evt.preventDefault)evt.preventDefault()},onEvent:function(w,f,of,event){if(Sfera.UI.skipButtonEvents)return;var evt=window.event||event;if(w=="touchstart"||w=="touchend"||w=="touchmove"){if(!Sfera.Device.touch)return false}else{if(evt)this.preventDefault(evt);if(Sfera.Device.touch)return false}if(!this.data)this.initData();var swi=this.data.attrs[this._attributes["switch"]];var swip=swi?this.data.attrs[this._attributes["pressed"]]:false;var nswip=swip;var s="";if(!this.data.attrs[this._attributes["disabled"]])switch(w){case"touchstart":Sfera.UI.setPressedButton(this);lastButton=null;touchStartX=evt.touches[0].clientX;touchStartY=evt.touches[0].clientY;s="down";if(swi)nswip=!swip;this.disableAndroidLongPress(evt,this.element);break;case"touchmove":if(Sfera.UI.getPressedButton()==this){s="down";if(!this.dontLiftOnMove&&(Math.abs(evt.touches[0].clientX-touchStartX)>30||Math.abs(evt.touches[0].clientY-touchStartY)>30)){Sfera.UI.setPressedButton(null);f=of}}this.disableAndroidLongPress(evt,this.element);break;case"touchend":if(Sfera.UI.getPressedButton()!=this){f=null}else{Sfera.UI.updateLastButton();this.preventDefault(evt)}Sfera.UI.setPressedButton(null);this.disableAndroidLongPress(evt,this.element);break;case"mouseover":var pressedBt=Sfera.UI.getPressedButton();if(pressedBt){if(pressedBt==this.element)s="down"}else if(Sfera.UI.overEnabled)s="over";break;case"mousemove":if(Sfera.UI.overEnabled)s="over";break;case"mouseout":var reltg;if(evt)reltg=evt.relatedTarget?evt.relatedTarget:evt.toElement;if(reltg){while(reltg&&reltg!=this.element&&reltg.nodeName!="BODY")reltg=reltg.parentNode;if(reltg==this.element)return}Sfera.UI.setPressedButton(null);break;case"mousedown":Sfera.UI.setPressedButton(this);lastButton=null;s="down";if(swi)nswip=!swip;break;case"mouseup":if(Sfera.UI.getPressedButton()!=this){f=null}else{Sfera.UI.updateLastButton()}Sfera.UI.setPressedButton(null);if(Sfera.UI.overEnabled)s="over";break}if(s!=this.data.state||nswip!=swip){this.data.state=s;if(swi)this.data.attrs[this._attributes["pressed"]]=nswip;this.updateClass();if(this._linked){for(var i=0;i<this._linked.length;i++){if(s!=this._linked[i].data.state){this._linked[i].data.state=s;this._linked[i].updateClass()}}}}if(f&&f!="null"&&!this.data.attrs[this._attributes["disabled"]]){var func=typeof f=="string"?new Function("event","element",f):f;func(event,this.element)}return false}};Sfera.Net=new function(){this.getURL=function(name){switch(name){case"dictionary":return Sfera.client.name+(Sfera.client.isLogin?"/login":"")+"/dictionary.xml";case"index":return Sfera.client.name+(Sfera.client.isLogin?"/login":"")+"/index.xml";case"subscribe":return"subscribe?id="+(Sfera.Net.subscribeId?Sfera.Net.subscribeId:"");case"state":return"state/"+Sfera.Net.subscribeId+"?ts="+Sfera.client.stateTs;case"command":return"command";case"event":return"event";case"websocket":return(Sfera.Browser.getLocation().protocol=="https:"?"wss:":"ws:")+"//"+Sfera.Browser.getLocation().host+"/api/websocket"}};var _defaultConfig={enableDebug:true,automaticOpen:true,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null};var req;var webSocket;var wsConnected=false;var self=this;var httpBaseUrl="/";var connectionId;var pingInterval;var responseTimeout;var connCheckTimeoutId;var cSync="";var self=this;this.stateTs=-1;this.subscribed=false;this.localTs={dictionary:-1,index:-1};this.remoteTs={dictionary:-1,index:-1};this.onMessage=new Sfera.Signal;this.onEvent=new Sfera.Signal;this.onReply=new Sfera.Signal;this.onUpdateDictionary=new Sfera.Signal;this.onUpdateIndex=new Sfera.Signal;function onWsOpen(event){if(event.data===undefined)return;Sfera.Debug.log(Sfera.Utils.getDate("hisu")+" - websocket: open, sending subscribe",event.data);self.wsSend(self.getURL("subscribe")+"&nodes=*")}function onWsMessage(event){console.log(Sfera.Utils.getDate("hisu")+" - received: "+event.data);if(event.data=="&"){resetConnCheckTimeout();self.wsSend("&")}else{self.onMessage.dispatch(event.data);Sfera.Debug.log("websocket: onmessage",event.data);json=JSON.parse(event.data);switch(json.type){case"reply":self.onReply.dispatch(json);break;case"connection":connectionId=json.connectionId;pingInterval=parseInt(json.pingInterval);responseTimeout=parseInt(json.responseTimeout);resetConnCheckTimeout();var tag=(new Date).getTime();var r={action:"subscribe",nodes:"*",tag:tag};self.wsSend(JSON.stringify(r));wsConnected=true;break;case"event":self.onEvent.dispatch(json);break}}}function onWsError(event){console.log("here",event);self.wsOpen()}function getWsCloseReason(code){switch(code){case 1e3:return"Normal closure, meaning that the purpose for which the connection was established has been fulfilled.";case 1001:return'An endpoint is "going away", such as a server going down or a browser having navigated away from a page.';case 1002:return"An endpoint is terminating the connection due to a protocol error";case 1003:return"An endpoint is terminating the connection because it has received a type of data it cannot accept (e.g., an endpoint that understands only text data MAY send this if it receives a binary message).";case 1004:return"Reserved. The specific meaning might be defined in the future.";case 1005:return"No status code was actually present.";case 1006:return"The connection was closed abnormally, e.g., without sending or receiving a Close control frame";case 1007:return"An endpoint is terminating the connection because it has received data within a message that was not consistent with the type of the message (e.g., non-UTF-8 [http://tools.ietf.org/html/rfc3629] data within a text message).";case 1008:return'An endpoint is terminating the connection because it has received a message that "violates its policy". This reason is given either if there is no other sutible reason, or if there is a need to hide specific details about the policy.';case 1009:return"An endpoint is terminating the connection because it has received a message that is too big for it to process.";case 1010:return"An endpoint (client) is terminating the connection because it has expected the server to negotiate one or more extension, but the server didn't return them in the response message of the WebSocket handshake. <br /> Specifically, the extensions that are needed are: "+event.reason;case 1011:return"A server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request.";case 1015:return"The connection was closed due to a failure to perform a TLS handshake (e.g., the server certificate can't be verified)."}return"Unknown reason"}function onWsClose(event){var reason;wsConnected=false;self.wsOpen();reason=event.code+" - "+getWsCloseReason(event.code);Sfera.Debug.log(Sfera.Utils.getDate("hisu")+" - web socket: connection closed",reason)}this.wsOpen=function(){var url=self.getURL("websocket");console.log(Sfera.Utils.getDate("hisu")+" - opening socket on "+url);if(webSocket!==undefined&&webSocket.readyState!==WebSocket.CLOSED){Sfera.Debug.log(Sfera.Utils.getDate()+" - websocket: is already opened.");return}if(connectionId!=null)url+="?cid="+connectionId;webSocket=new WebSocket(url);webSocket.onopen=onWsOpen;webSocket.onmessage=onWsMessage;webSocket.onclose=onWsClose;webSocket.onerror=onWsError};this.wsSend=function(txt){console.log(Sfera.Utils.getDate("hisu")+" - sending:  "+txt);webSocket.send(txt)};this.wsClose=function(){webSocket.close()};function resetConnCheckTimeout(){clearTimeout(connCheckTimeoutId);setTimeout(this.wsClose,pingInterval+responseTimeout)}function getTimestamp(){return(new Date).getTime()}this.connect=function(){if(!req){req=new Sfera.Net.Request;req.onLoaded=onReqLoaded;req.onError=onReqError}this.sync()};this.sync=function(){for(var s in this.localTs){if(this.localTs[s]==-1){cSync=s;req.open(httpBaseUrl+self.getURL(s),20);return}}if(true){self.wsOpen();return}if(!this.subscribed){cSync="subscribe";req.open(urls.get("subscribe"));return}cSync="state";req.open(httpBaseUrl+urls.get("state"))};function onReqLoaded(){console.log(cSync+" loaded");Sfera.Debug.log("xmlreq: loaded",req.getResponseText());if(self.localTs[cSync]!=null)self.localTs[cSync]=getTimestamp();var state;switch(cSync){case"dictionary":console.log("loaded dictionary");self.onUpdateDictionary.dispatch(req.getResponseXML());break;case"index":console.log("loaded index");self.onUpdateIndex.dispatch(req.getResponseXML());break;case"subscribe":self.subscribed=true;case"state":state=JSON.parse(req.getResponseText());if(state.timestamp)self.stateTs=state.timestamp;break}self.sync()}function onReqError(){console.log("error")}this.getHostName=function(){if(window.location&&window.location.hostname){return window.location.hostname}return null};this.sendCommand=function(req){var r={action:"command",cmd:req.command,tag:req.tag};this.wsSend(JSON.stringify(r))};this.sendEvent=function(req){var r={action:"event",id:req.id,value:req.value,tag:req.tag};this.wsSend(JSON.stringify(r))}};Sfera.Net=Sfera.Net||{};Sfera.Net.Request=function(){var req=null;var status;var reqTimeout=null;this.url="";this.onLoaded=null;this.onStop=null;this.onRetry=null;this.onError=null;this.onRequest=null;this.onConnectionError=null;this.onUnauthorized=null;this.maxWaitingTime=0;var waitTimeout=null;this.retryOnErrorDelay=0;this.maxRetries=0;this.retries=0;var foo=this;this.ERROR_GENERAL=0;this.ERROR_CONNECTION=1;this.ERROR_MAXWAITTIME=2;this.ERROR_UNAUTHORIZED=401;this.ERROR_FORBIDDEN=403;this.ERROR_NOT_FOUND=404;this.init=function(){status=0;if(window.XMLHttpRequest){req=new XMLHttpRequest;req.onreadystatechange=onReadyStateChange}else if(window.ActiveXObject){req=new ActiveXObject("Microsoft.XMLHTTP");if(req){req.onreadystatechange=onReadyStateChange}}};this.open=function(url,ms){if(status==1)foo.stop();status=0;if(url){foo.url=url;foo.retries=0}if(reqTimeout){clearTimeout(reqTimeout);reqTimeout=null}if(waitTimeout){clearTimeout(waitTimeout);waitTimeout=null}if(ms){reqTimeout=setTimeout(foo.open,ms);return}if(!req)foo.init();status=1;if(foo.onRequest)foo.onRequest();try{req.open("GET",foo.url,true)}catch(err){onError(foo.ERROR_GENERAL);return}req.send();if(foo.maxWaitingTime){waitTimeout=setTimeout(onWaitTimeout,foo.maxWaitingTime)}};this.stop=function(){if(status==1||reqTimeout){if(this.onStop)this.onStop(status==1)}if(status==1){status=-1;req.abort();this.init()}if(reqTimeout){clearTimeout(reqTimeout);reqTimeout=null}if(waitTimeout){clearTimeout(waitTimeout);waitTimeout=null}status=0};this.repeat=function(ms){this.open(null,ms)};function onWaitTimeout(){if(waitTimeout){clearTimeout(waitTimeout);waitTimeout=null}status=-1;req.abort();onError(foo.ERROR_MAXWAITTIME);foo.init()}function onReadyStateChange(){if(req.readyState==null)return;switch(req.readyState){case 0:case 1:return;case 2:case 3:return;case 4:}if(waitTimeout){clearTimeout(waitTimeout);waitTimeout=null}if(status!=1)return;status=2;if(req.status!=200){onError(req.status);return}var res="";try{res=req.responseText}catch(err){onError(foo.ERROR_GENERAL);return}if(foo.onLoaded)foo.onLoaded(foo)}function onError(errCode){switch(errCode){case foo.ERROR_UNAUTHORIZED:if(foo.onUnauthorized){foo.onUnauthorized();return}break}if(errCode>=400&&foo.onConnectionError){foo.onConnectionError();return}if(foo.retryOnErrorDelay){if(!foo.maxRetries||foo.retries<foo.maxRetries){foo.retries++;if(foo.onRetry)foo.onRetry();if(foo.retryOnErrorDelay){foo.repeat(foo.retryOnErrorDelay);return}}}if(foo.onError)foo.onError(errCode)}this.getResponseJSON=function(){var res=this.getResponseText();if(res)return JSON.parse(res);else return null};this.getResponseText=function(){var res="";try{res=req.responseText;return res}catch(err){return null}};this.getResponseXML=function(){var res="";try{res=req.responseXML;return res}catch(err){return null}};this.isReady=function(){return status!=1}};Sfera.Skins=function(client){this.client=client};Sfera.Browser=new function(){var location;this.reload=function(){window.location.reload()};this.preventDefault=function(evt){if(evt.returnValue)evt.returnValue=false;if(evt.preventDefault)evt.preventDefault()};this.changeUrl=function(title,url){if(typeof history.pushState!="undefined"){var obj={Title:title,Url:url};history.pushState(obj,obj.Title,obj.Url);return true}return false};this.updateUrl=function(pageId,pageTitle){var location=this.getLocation();hash=pageId=="page:homepage"?"":pageId;document.title=pageTitle;if(location.hash!=hash){lastHash=hash;var url=location.pathname+"#"+pageId;if(pageId&&location.search)url+="?"+location.search;this.changeUrl(pageTitle,url)}};this.getLocation=function(){var url=window.location.href;if(!location||location.url!=url){var hash=window.location.hash,search=window.location.search,a;if(hash){if(hash[0]=="#")hash=hash.substr(1);if(hash.indexOf("?")!=-1){a=hash.split("?");hash=a[0];search=a[1]}}if(search){if(search[0]=="?")search=search.substr(1);if(search.indexOf("#")!=-1){a=search.split("#");search=a[0];hash=a[1]}}var sp=window.location.pathname.split("/");location={url:url,host:window.location.host,protocol:window.location.protocol,pathname:window.location.pathname,hash:hash,search:search,"interface":sp[1],login:sp[2]=="login"}}return location};var lastHash=null;var self=this;this.start=function(){setInterval(function(){var location=Sfera.Browser.getLocation();var locHash=location.hash=="page:homepage"?"":location.hash;if(locHash!==lastHash){lastHash=locHash;Sfera.client.showPage(location.hash?location.hash:"homepage")}},100)}};Sfera.Device=function(){this.deviceReadyAt=0;this.initialized=false;this.desktop=false;this.iOS=false;this.cocoonJS=false;this.cocoonJSApp=false;this.cordova=false;this.node=false;this.nodeWebkit=false;this.electron=false;this.ejecta=false;this.crosswalk=false;this.android=false;this.chromeOS=false;this.linux=false;this.macOS=false;this.windows=false;this.windowsPhone=false;this.canvas=false;this.canvasBitBltShift=null;this.webGL=false;this.file=false;this.fileSystem=false;this.localStorage=false;this.worker=false;this.css3D=false;this.pointerLock=false;this.typedArray=false;this.vibration=false;this.getUserMedia=true;this.quirksMode=false;this.touch=false;this.mspointer=false;this.wheelEvent=null;this.arora=false;this.chrome=false;this.chromeVersion=0;this.epiphany=false;this.firefox=false;this.firefoxVersion=0;this.ie=false;this.ieVersion=0;this.trident=false;this.tridentVersion=0;this.mobileSafari=false;this.midori=false;this.opera=false;this.safari=false;this.webApp=false;this.silk=false;this.audioData=false;this.webAudio=false;this.ogg=false;this.opus=false;this.mp3=false;this.wav=false;this.m4a=false;this.webm=false;this.oggVideo=false;this.h264Video=false;this.mp4Video=false;this.webmVideo=false;this.vp9Video=false;this.hlsVideo=false;this.iPhone=false;this.iPhone4=false;this.iPad=false;this.pixelRatio=0;this.littleEndian=false;this.LITTLE_ENDIAN=false;this.support32bit=false;this.fullscreen=false;this.requestFullscreen="";this.cancelFullscreen="";this.fullscreenKeyboard=false};Sfera.Device=new Sfera.Device;Sfera.Device.onInitialized=new Sfera.Signal;Sfera.Device.whenReady=function(callback,context,nonPrimer){var readyCheck=this._readyCheck;if(this.deviceReadyAt||!readyCheck){callback.call(context,this)}else if(readyCheck._monitor||nonPrimer){readyCheck._queue=readyCheck._queue||[];readyCheck._queue.push([callback,context])}else{readyCheck._monitor=readyCheck.bind(this);readyCheck._queue=readyCheck._queue||[];readyCheck._queue.push([callback,context]);var cordova=typeof window.cordova!=="undefined";var cocoonJS=navigator["isCocoonJS"];if(document.readyState==="complete"||document.readyState==="interactive"){window.setTimeout(readyCheck._monitor,0)}else if(cordova&&!cocoonJS){document.addEventListener("deviceready",readyCheck._monitor,false)}else{document.addEventListener("DOMContentLoaded",readyCheck._monitor,false);window.addEventListener("load",readyCheck._monitor,false)}}};Sfera.Device._readyCheck=function(){var readyCheck=this._readyCheck;if(!document.body){window.setTimeout(readyCheck._monitor,20)}else if(!this.deviceReadyAt){this.deviceReadyAt=Date.now();document.removeEventListener("deviceready",readyCheck._monitor);document.removeEventListener("DOMContentLoaded",readyCheck._monitor);window.removeEventListener("load",readyCheck._monitor);this._initialize();this.initialized=true;this.onInitialized.dispatch(this);var item;while(item=readyCheck._queue.shift()){var callback=item[0];var context=item[1];callback.call(context,this)}this._readyCheck=null;this._initialize=null;this.onInitialized=null}};Sfera.Device._initialize=function(){var device=this;function _checkOS(){var ua=navigator.userAgent;if(/Playstation Vita/.test(ua)){device.vita=true}else if(/Kindle/.test(ua)||/\bKF[A-Z][A-Z]+/.test(ua)||/Silk.*Mobile Safari/.test(ua)){device.kindle=true}else if(/Android/.test(ua)){device.android=true}else if(/CrOS/.test(ua)){device.chromeOS=true}else if(/iP[ao]d|iPhone/i.test(ua)){device.iOS=true}else if(/Linux/.test(ua)){device.linux=true}else if(/Mac OS/.test(ua)){device.macOS=true}else if(/Windows/.test(ua)){device.windows=true}if(/Windows Phone/i.test(ua)||/IEMobile/i.test(ua)){device.android=false;device.iOS=false;device.macOS=false;device.windows=true;device.windowsPhone=true}var silk=/Silk/.test(ua);if(device.windows||device.macOS||device.linux&&!silk||device.chromeOS){device.desktop=true}if(device.windowsPhone||/Windows NT/i.test(ua)&&/Touch/i.test(ua)){device.desktop=false}}function _checkFeatures(){device.canvas=!!window["CanvasRenderingContext2D"]||device.cocoonJS;try{device.localStorage=!!localStorage.getItem}catch(error){device.localStorage=false}device.file=!!window["File"]&&!!window["FileReader"]&&!!window["FileList"]&&!!window["Blob"];device.fileSystem=!!window["requestFileSystem"];device.webGL=function(){try{var canvas=document.createElement("canvas");canvas.screencanvas=false;return!!window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))}catch(e){return false}}();device.webGL=!!device.webGL;device.worker=!!window["Worker"];device.pointerLock="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;device.quirksMode=document.compatMode==="CSS1Compat"?false:true;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;device.getUserMedia=device.getUserMedia&&!!navigator.getUserMedia&&!!window.URL;if(device.firefox&&device.firefoxVersion<21){device.getUserMedia=false}}function _checkInput(){if("ontouchstart"in document.documentElement||window.navigator.maxTouchPoints&&window.navigator.maxTouchPoints>=1){device.touch=true}if(window.navigator.msPointerEnabled||window.navigator.pointerEnabled){device.mspointer=true}if(!device.cocoonJS){if("onwheel"in window||device.ie&&"WheelEvent"in window){device.wheelEvent="wheel"}else if("onmousewheel"in window){device.wheelEvent="mousewheel"}else if(device.firefox&&"MouseScrollEvent"in window){device.wheelEvent="DOMMouseScroll"}}}function _checkFullScreenSupport(){var fs=["requestFullscreen","requestFullScreen","webkitRequestFullscreen","webkitRequestFullScreen","msRequestFullscreen","msRequestFullScreen","mozRequestFullScreen","mozRequestFullscreen"];var element=document.createElement("div");for(var i=0;i<fs.length;i++){if(element[fs[i]]){device.fullscreen=true;device.requestFullscreen=fs[i];break}}var cfs=["cancelFullScreen","exitFullscreen","webkitCancelFullScreen","webkitExitFullscreen","msCancelFullScreen","msExitFullscreen","mozCancelFullScreen","mozExitFullscreen"];if(device.fullscreen){for(var i=0;i<cfs.length;i++){if(document[cfs[i]]){device.cancelFullscreen=cfs[i];break}}}if(window["Element"]&&Element["ALLOW_KEYBOARD_INPUT"]){device.fullscreenKeyboard=true}}function _checkBrowser(){var ua=navigator.userAgent;if(/Arora/.test(ua)){device.arora=true}else if(/Chrome\/(\d+)/.test(ua)&&!device.windowsPhone){device.chrome=true;device.chromeVersion=parseInt(RegExp.$1,10)}else if(/Epiphany/.test(ua)){device.epiphany=true}else if(/Firefox\D+(\d+)/.test(ua)){device.firefox=true;device.firefoxVersion=parseInt(RegExp.$1,10)}else if(/AppleWebKit/.test(ua)&&device.iOS){device.mobileSafari=true}else if(/MSIE (\d+\.\d+);/.test(ua)){device.ie=true;device.ieVersion=parseInt(RegExp.$1,10)}else if(/Midori/.test(ua)){device.midori=true}else if(/Opera/.test(ua)){device.opera=true}else if(/Safari/.test(ua)&&!device.windowsPhone){device.safari=true}else if(/Trident\/(\d+\.\d+)(.*)rv:(\d+\.\d+)/.test(ua)){device.ie=true;device.trident=true;device.tridentVersion=parseInt(RegExp.$1,10);device.ieVersion=parseInt(RegExp.$3,10)}if(/Silk/.test(ua)){device.silk=true}if(navigator["standalone"]){device.webApp=true}if(typeof window.cordova!=="undefined"){device.cordova=true}if(typeof process!=="undefined"&&typeof require!=="undefined"){device.node=true}if(device.node&&typeof process.versions==="object"){device.nodeWebkit=!!process.versions["node-webkit"];device.electron=!!process.versions.electron}if(navigator["isCocoonJS"]){device.cocoonJS=true}if(device.cocoonJS){try{device.cocoonJSApp=typeof CocoonJS!=="undefined"}catch(error){device.cocoonJSApp=false}}if(typeof window.ejecta!=="undefined"){device.ejecta=true}if(/Crosswalk/.test(ua)){device.crosswalk=true}}function _checkVideo(){var videoElement=document.createElement("video");var result=false;try{if(result=!!videoElement.canPlayType){if(videoElement.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,"")){device.oggVideo=true}if(videoElement.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,"")){device.h264Video=true;device.mp4Video=true}if(videoElement.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,"")){device.webmVideo=true}if(videoElement.canPlayType('video/webm; codecs="vp9"').replace(/^no$/,"")){device.vp9Video=true}if(videoElement.canPlayType('application/x-mpegURL; codecs="avc1.42E01E"').replace(/^no$/,"")){device.hlsVideo=true}}}catch(e){}}function _checkAudio(){device.audioData=!!window["Audio"];device.webAudio=!!(window["AudioContext"]||window["webkitAudioContext"]);var audioElement=document.createElement("audio");var result=false;try{if(result=!!audioElement.canPlayType){if(audioElement.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")){device.ogg=true}if(audioElement.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,"")||audioElement.canPlayType("audio/opus;").replace(/^no$/,"")){device.opus=true}if(audioElement.canPlayType("audio/mpeg;").replace(/^no$/,"")){device.mp3=true}if(audioElement.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"")){device.wav=true}if(audioElement.canPlayType("audio/x-m4a;")||audioElement.canPlayType("audio/aac;").replace(/^no$/,"")){device.m4a=true}if(audioElement.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")){device.webm=true}}}catch(e){}}function _checkDevice(){device.pixelRatio=window["devicePixelRatio"]||1;device.iPhone=navigator.userAgent.toLowerCase().indexOf("iphone")!=-1;device.iPhone4=device.pixelRatio==2&&device.iPhone;device.iPad=navigator.userAgent.toLowerCase().indexOf("ipad")!=-1;navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate;if(navigator.vibrate){device.vibration=true}}_checkOS();_checkAudio();_checkVideo();_checkBrowser();_checkDevice();_checkFeatures();_checkFullScreenSupport();_checkInput()};Sfera.Device.canPlayAudio=function(type){if(type==="mp3"&&this.mp3){return true}else if(type==="ogg"&&(this.ogg||this.opus)){return true}else if(type==="m4a"&&this.m4a){return true}else if(type==="opus"&&this.opus){return true}else if(type==="wav"&&this.wav){return true}else if(type==="webm"&&this.webm){return true}return false};Sfera.Device.canPlayVideo=function(type){if(type==="webm"&&(this.webmVideo||this.vp9Video)){return true}else if(type==="mp4"&&(this.mp4Video||this.h264Video)){return true}else if((type==="ogg"||type==="ogv")&&this.oggVideo){return true}else if(type==="mpeg"&&this.hlsVideo){return true}return false};window.man=function(what){var c=Sfera.Utils.capitalize(what);if(Sfera.Components[c]){var co=new Sfera.Components[c]({});var hstr="* Component "+co.type+" *****************";console.log(hstr);var sstr="";for(var sub in co.subComponents){var str=" - "+sub+" ";while(str.length<20)str+=" ";str+=co.subComponents[sub].type;sstr+=str+"\n"}if(str){console.log("* SubComponents:");console.log(sstr)}console.log("* Attributes:");for(var attr in co.attributes){var a=co.attributes[attr];var str=" - "+attr;while(str.length<20)str+=" ";str+=a.type;var av=co.attributes[attr].values;if(av){if(Sfera.Utils.isFunction(av))av=av();if(Sfera.Utils.isArray(av)){while(str.length<35)str+=" ";str+="<"+av.join("|")+">"}}console.log(str)}console.log(hstr)}};window.help=function(){var hstr="* Help *************************\n";hstr+='* man("<component name>")\n';hstr+='* client.setAttribute("<component id>","<attribute name>","<value>")\n';hstr+="* Help *************************\n";console.log(hstr)};Sfera.Utils=function(){this.mixin=function(a,b){};this.extend=function(c,e){c.prototype=Object.create(e.prototype);c.prototype.constructor=c;c.prototype.ancestor=e.prototype};this.initClass=function(c){c.prototype.constructor=c};function filterNone(){return NodeFilter.FILTER_ACCEPT}this.getAllCommentChildNodes=function(rootNode){var comments=[];var iterator=document.createNodeIterator(rootNode,NodeFilter.SHOW_COMMENT,filterNone,false);var curNode;while(curNode=iterator.nextNode()){comments.push(curNode)}return comments};this.getFirstChildNodeOfType=function(rootNode,type,recursive){for(var i=0;i<rootNode.childNodes.length;i++){if(rootNode.childNodes[i].nodeType==type){return rootNode.childNodes[i]}if(recursive&&rootNode.childNodes[i].childNodes){var r=this.getFirstChildNodeOfType(rootNode.childNodes[i],type,recursive);if(r!=null)return r}}return null};this.getFirstChildNodeWithName=function(rootNode,name,recursive){var i,r;for(i=0;i<rootNode.childNodes.length;i++){if(rootNode.childNodes[i].getAttribute&&rootNode.childNodes[i].getAttribute("name")==name){return rootNode.childNodes[i]}if(recursive&&rootNode.childNodes[i].childNodes){r=this.getFirstChildNodeWithName(rootNode.childNodes[i],name,recursive);if(r!=null)return r}}return null};this.getComponentElements=function(rootNode,recursive,obj){var obj=obj||{},name,i,r;for(var i=0;i<rootNode.childNodes.length;i++){if(rootNode.childNodes[i].getAttribute){name=rootNode.childNodes[i].getAttribute("name");if(name)obj[name]=rootNode.childNodes[i]}if(recursive&&rootNode.childNodes[i].childNodes&&rootNode.childNodes[i].childNodes.length&&!rootNode.childNodes[i].getAttribute("data-controller")){obj=this.getComponentElements(rootNode.childNodes[i],recursive,obj)}}return obj};this.getCDATA=function(rootNode){var node=this.getFirstChildNodeOfType(rootNode,4);return node?node.nodeValue:""};this.isString=function(v){return typeof v==="string"||v instanceof String};this.isFunction=function(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)};this.isArray=function(obj){
return obj&&Object.prototype.toString.call(obj)==="[object Array]"};this.capitalize=function(str){return str[0].toUpperCase()+str.substr(1)};this.camelToDash=function(str){return str.replace(/\W+/g,"-").replace(/([a-z\d])([A-Z])/g,"$1-$2").toLowerCase()};this.dashToCamel=function(str){return str.toLowerCase().replace(/\W+(.)/g,function(x,chr){return chr.toUpperCase()})};this.getKeyFromCode=function(code){switch(code){case 8:return"del";case 9:return"tab";case 13:return"enter";case 32:return"space";case 37:return"left";case 38:return"up";case 39:return"right";case 40:return"down";default:var c=String.fromCharCode(code);return c?c.toLowerCase():null}};this.getDate=function(format){function pan(str,len){str=str+"";if(!len)len=2;while(str.length<len)str="0"+str;return str}var date=new Date;if(!format){format="dmyhisu"}var f={};for(var i=0;i<format.length;i++)f[format[i]]=true;var str="";if(f.d){str+=pan(date.getDate())}if(f.m){str+=(str?"/":"")+pan(date.getMonth()+1)}if(f.y){str+=(str?"/":"")+date.getFullYear()}if(f.h){str+=(str?" ":"")+pan(date.getHours())}if(f.i){str+=(str?":":"")+pan(date.getMinutes())}if(f.s){str+=(str?":":"")+pan(date.getSeconds())}if(f.u){str+=(str?":":"")+pan(date.getMilliseconds(),3)}return str};this.getMouseRelativePosition=function(evt,target){var ep=this.getElementAbsolutePosition(target);var p=this.getMouseAbsolutePosition(evt,target);return{x:p.x-ep.x,y:p.y-ep.y}};this.getMouseAbsolutePosition=function(evt,target){var x,y;if(Sfera.Device.touch&&evt.touches&&evt.touches[0]){x=evt.touches[0].pageX;y=evt.touches[0].pageY}else if(evt.pageX!=null&&evt.pageY!=null){x=evt.pageX;y=evt.pageY}else{x=evt.layerX!=null?evt.layerX:evt.offsetX;y=evt.layerY!=null?evt.layerY:evt.offsetY;var c=target||evt.target||evt.srcElement;var p=this.getElementAbsolutePosition(c);x+=p.x;y+=p.y}if(this.scaleDelta&&this.scaleDelta!=1){x*=this.scaleDelta;y*=this.scaleDelta}return{x:x,y:y}};this.getElementAbsolutePosition=function(c){var x=0;var y=0;while(c&&c.offsetLeft!=null&&c.offsetTop!=null){x+=c.offsetLeft;y+=c.offsetTop;c=c.offsetParent||c.parentNode}return{x:x,y:y}};this.initMouseWheelEvent=function(e,f){if(!Sfera.Device.touch)window.addEvent(browser.browser=="Firefox"?"DOMMouseScroll":"mousewheel",e,f)};if(typeof window.DOMParser!="undefined"){this.parseXML=function(xmlStr){return(new window.DOMParser).parseFromString(xmlStr,"text/xml")}}else if(typeof window.ActiveXObject!="undefined"&&new window.ActiveXObject("Microsoft.XMLDOM")){this.parseXML=function(xmlStr){var xmlDoc=new window.ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(xmlStr);return xmlDoc}}else{throw new Error("No XML parser found")}};Sfera.Utils=new Sfera.Utils;Array.prototype.equals=function(array,strict){if(!array)return false;if(arguments.length==1)strict=true;if(this.length!=array.length)return false;for(var i=0;i<this.length;i++){if(this[i]instanceof Array&&array[i]instanceof Array){if(!this[i].equals(array[i],strict))return false}else if(strict&&this[i]!=array[i]){return false}else if(!strict){return this.sort().equals(array.sort(),true)}}return true};function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n)}String.prototype.trim=function(){var str=this.replace(/^\s\s*/,""),ws=/\s/,i=str.length;while(ws.test(str.charAt(--i)));return str.slice(0,i+1)};if(typeof String.prototype.startsWith!="function"){String.prototype.startsWith=function(str){return this.slice(0,str.length)==str}}if(typeof String.prototype.endsWith!="function"){String.prototype.endsWith=function(str){return this.slice(-str.length)==str}}Number.prototype.mod=function(n){return(this%n+n)%n};Number.prototype.next=function(b){return(this+1).mod(b)};Number.prototype.previous=function(b){return(this-1).mod(b)};if(!Array.prototype.isArray){Array.prototype.isArray=function(vArg){return Object.prototype.toString.call(vArg)==="[object Array]"}}Array.prototype.unique=function(){var a=[];var l=this.length;for(var i=0;i<l;i++){for(var j=i+1;j<l;j++){if(this[i]===this[j])j=++i}a.push(this[i])}return a};Array.prototype.last=function(){if(!this.length)return null;return this[this.length-1]};Array.prototype.clone=function(){return this.slice(0)};Array.prototype.intersect=function(arr){var a=[];var l=this.length;for(var i=0;i<l;i++){if(arr.indexOf(this[i])!=-1){a.push(this[i])}}return a};Array.prototype.same=function(arr){if(this.length!=arr.length)return false;for(var i=0;i<this.length;i++){if(this[i]!=null&&arr[i]!=null&&typeof this[i]==="object"&&typeof arr[i]==="object"&&this[i].isArray&&arr[i].isArray){if(!this[i].same(arr[i]))return false}else if(this[i]!=arr[i]){return false}}return true};if(!Array.prototype.indexOf){Array.prototype.indexOf=function(searchElement,fromIndex){"use strict";if(this==null){throw new TypeError}var t=Object(this);var len=t.length>>>0;if(len===0){return-1}var n=0;if(arguments.length>1){n=Number(arguments[1]);if(n!=n){n=0}else if(n!=0&&n!=Infinity&&n!=-Infinity){n=(n>0||-1)*Math.floor(Math.abs(n))}}if(n>=len){return-1}var k=n>=0?n:Math.max(len-Math.abs(n),0);for(;k<len;k++){if(k in t&&t[k]===searchElement){return k}}return-1}}Array.prototype.clean=function(deleteValue){for(var i=0;i<this.length;i++){if(this[i]==deleteValue){this.splice(i,1);i--}}return this};window.addEvent=function(event,target,method){if(target.addEventListener){target.addEventListener(event,method,false)}else if(target.attachEvent){target.attachEvent("on"+event,method)}else{target["on"+event]=method}};window.removeEvent=function(event,target,method){if(target.removeEventListener){target.removeEventListener(event,method,false)}else if(target.attachEvent){target.detachEvent("on"+event,method)}else{target["on"+event]=null}};Sfera.Components.create("_Base",{id:null,requireUpdate:null,attributes:{id:{type:"string",set:function(value){this.value=value;this.component.id=value;this.component.element.setAttribute("data-id",value)},get:function(){return this.attributeValues.id}}},init:function(){this.elements={}},getAttribute:function(name){if(this.attributes[name]){return this.attributes[name].get()}},setAttribute:function(name,value,manualUpdate){if(this.attributes[name]){this.attributes[name].set(value,manualUpdate)}},update:function(){},"super":function(superClassName,methodName){Sfera.Components[superClassName].prototype[methodName].call(this)},setSource:function(src){this.processed=false},addChild:function(child){this.children.push(child);child.parent=this;if(this.element&&child.element){this.element.appendChild(child.element)}},addSubComponent:function(co){if(co.id===false)co.id=this.id+".icon";var id=co.id;if(this.id)id=id.substr(this.id.length+1);this.subComponents[id]=co;co.parent=this},isVisible:function(){return true},isEnabled:function(){return true}});Sfera.Components.create("_Field",{presets:["Visibility","Position","Size","Style"],attributes:{value:{}},init:function(){this.focused=false},focus:function(){},blur:function(){},onFocus:function(){},onBlur:function(){}});if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=Sfera}exports.Sfera=Sfera}else if(typeof define!=="undefined"&&define.amd){define("Sfera",function(){return root.Sfera=Sfera}())}else{root.Sfera=Sfera}}).call(this);Sfera.Skins.Default=function(){this.VERSION="1.0";this.styles={Input:["default","clear"],Button:["default","clear","icon"],Checkbox:["default","radio","switch","clear"],Radio:["default"]};this.colors={Button:["default","light","stable","positive","calm","balanced","energized","assertive","royal","dark"]}};Sfera.Components.create("Button",{presets:["Visibility","Position","Size","Style","Color"],attributes:{command:{type:"string"},label:{update:function(){var co=this.component;var label=co.subComponents.label;label.setAttribute("label",this.value);if(this.value){co.elements.label.style.display=""}else{co.elements.label.style.display="none"}}},icon:{type:"string","default":"",update:function(){var co=this.component;var icon=co.subComponents.icon;icon.setAttribute("source",this.value);if(this.value){co.elements.icon.style.display=""}else{co.elements.icon.style.display="none"}}},fontSize:{update:function(){var co=this.component;var label=co.subComponents.label;label.setAttribute("fontSize",this.value)}},onClick:{type:"js"},onDown:{type:"js"},onMove:{type:"js"}},init:function(){this.elements=Sfera.Utils.getComponentElements(this.element,true,this.elements);this.button=new Sfera.UI.Button(this.elements.container,{ondown:this.onDown.bind(this),onup:this.onUp.bind(this),onmove:this.onMove.bind(this)});this.updateClass()},updateClass:function(){var col=this.getAttribute("color")||"default";var sty=this.getAttribute("style")||"default";this.button.setClassName("container"+(sty?" style_"+sty:"")+(col?" color_"+col:""))},onDown:function(){var f=this.getAttribute("onDown");Sfera.Custom.exec(f,this.id)},onMove:function(){var f=this.getAttribute("onMove");Sfera.Custom.exec(f,this.id)},onUp:function(){var f=this.getAttribute("onClick");Sfera.Custom.exec(f,this.id)}});Sfera.Components.create("Input",{"extends":"_Field",attributes:{type:{type:"string","default":"input",values:["input","textarea","color","date","datetime","email","number","password","tel","time","url"],update:function(){this.component.redraw()}},height:{update:function(){if(this.component.elements.field)this.component.elements.field.style.height=this.value+"px"}},focus:{type:"boolean",update:function(){if(this.value)this.component.focus()}},icon:{type:"string","default":"",update:function(){var co=this.component;var icon=co.subComponents.icon;icon.setAttribute("source",this.value);if(this.value){co.elements.icon.style.display=""}else{co.elements.icon.style.display="none"}}},eraseButton:{type:"boolean","default":"false",update:function(){var co=this.component;co.elements.erase.style.display=this.value?"":"none"}},value:{update:function(){if(this.component.elements.field)this.component.elements.field.value=this.value}},changeDelay:{type:"integer","default":"1000"},keyRegex:{type:"regexp"},valueRegex:{type:"regexp",compile:function(){this.value=Sfera.Compiler.compileAttributeValue(this,"^("+this.source+")$")}},fontSize:{type:"integer",update:function(){if(this.component.elements.field)this.component.elements.field.style.fontSize=this.value+"px"}},fontColor:{update:function(){if(this.component.elements.field)this.component.elements.field.style.color=this.value}},maxLength:{type:"integer"},onKeyUp:{type:"js"},onChange:{type:"js","default":"event(id,value)"},onEnter:{type:"js"},onFocus:{type:"js"},onBlur:{type:"js"}},init:function(){var self=this;this.value="";this.changeTimeout=null;this.elements=Sfera.Utils.getComponentElements(this.element,true,this.elements);this.eraseButton=new Sfera.UI.Button(this.elements.erase,{onclick:this.onErase.bind(this)})},focus:function(){this.elements.field.focus()},blur:function(){this.elements.field.blur()},redraw:function(){var value="";if(this.elements.field){this.elements.field.onfocus=null;this.elements.field.onblur=null;this.elements.field.onselectstart=null;value=this.elements.field.value;this.elements.field=null}var type=this.getAttribute("type");var phText=this.getAttribute("placeHolder");phText=phText?' placeholder="'+phText+'"':"";var style="";style=style?' style="'+style+'"':"";if(type=="textarea")this.elements.fieldC.innerHTML='<textarea class="field" '+style+phText+" /></textarea>";else this.elements.fieldC.innerHTML='<input class="field" type="'+type+'"'+style+phText+" />";this.elements.field=this.elements.fieldC.childNodes[0];this.elements.field.value=value;this.attributes.height.update();if(Sfera.Device.android=="Android"){this.elements.field.onfocus=function(){return false};this.elements.field.oninput=this.onUserChange}else{this.elements.field.onfocus=this.onFocus}this.elements.field.onblur=this.onBlur;this.elements.field.onselectstart=this.onSelectStart;this.elements.field.controller=this},updateClass:function(){this.element.className="component comp_input"+(this.focused?" focused":"");var sty=this.getAttribute("style");this.elements.container.className="container"+(sty?" style_"+sty:"")},onErase:function(){this.setAttribute("value","");this.onChangedTimeout()},onChanged:function(){var v=this.elements.field.value;if(v!=this.attributes.value.source){this.attributes.value.source=this.attributes.value.value=v;this.clearChangeTimeout();var changeDelay=this.getAttribute("changeDelay");var self=this;if(changeDelay)this.changeTimeout=setTimeout(function(){self.onChangedTimeout()},changeDelay)}},clearChangeTimeout:function(){if(this.changeTimeout){clearTimeout(this.changeTimeout);this.changeTimeout=null}},onChangedTimeout:function(){this.clearChangeTimeout();var f=this.getAttribute("onChange");var value=this.getAttribute("value");Sfera.Custom.exec(f,this.id,value)},onSelectStart:function(event){},onKeyDown:function(event){var code=event.keyCode;var c=Sfera.Utils.getKeyFromCode(code);var type=this.getAttribute("type");if(c=="enter"&&!this.onEnter()){c=""}if(c=="enter"&&type!="textarea"||c=="tab"){this.onChangedTimeout();Sfera.client.focusNext(event.shiftKey);if(c=="enter"&&type!="textarea")this.blur();return false}else{this.onChanged();return true}},onKeyPress:function(event){var code=event.keyCode;var c=Sfera.Utils.getKeyFromCode(code);var fieldE=this.elements.field;var value=this.getAttribute("value");var keyRegex=this.getAttribute("keyRegex");var maxLength=this.getAttribute("maxLength");function getSelectedText(){var text="";if(fieldE.selectionStart!=fieldE.selectionEnd){text=value.substr(fieldE.selectionStart,fieldE.selectionEnd)}else if(typeof window.getSelection!="undefined"){text=window.getSelection().toString()}else if(typeof document.selection!="undefined"&&document.selection.type=="Text"){text=document.selection.createRange().text}return text}if(!c&&value&&maxLength&&value.length>=maxLength&&!getSelectedText()){return false}if(!c&&keyRegex&&!event.ctrlKey&&!event.metaKey&&!keyRegex.test(String.fromCharCode(code)))return false;this.onChanged();return true},onKeyUp:function(event){var code=event.keyCode;var c=Sfera.Utils.getKeyFromCode(code);if(c!="enter"&&c!=="tab"){this.onChanged();return false}return true},onChange:function(){this.onChanged()},onEnter:function(){var f=this.getAttribute("onEnter");if(f){return Sfera.Custom.exec(f)}else{return true}},onFocus:function(){var co=this.controller;Sfera.client.setFocused(co);co.focused=true;co.updateClass()},onBlur:function(){var co=this.controller;co.onChanged();Sfera.client.clearFocused(co);co.focused=false;co.updateClass()},onShow:function(){if(this.getAttribute("focus"))this.focus()},onHide:function(){}});Sfera.Components.create("Image",{presets:["Visibility","Position","Size"],attributes:{source:{type:"string",update:function(){var c=this.component;var e=c.element;if(!this.value){e.innerHTML=""}else if(this.value.indexOf(".svg")==this.value.length-4){var req=new Sfera.Net.Request;req.init();req.onLoaded=function(){var xml=req.getResponseXML();var svg=xml.getElementsByTagName("svg")[0];e.innerHTML="";if(svg){e.appendChild(svg);svg.style.width=c.getAttribute("width");svg.style.height=c.getAttribute("height")}delete req};req.open(this.value)}else{e.innerHTML="<img src='"+this.value+"' width='100%' height='100%'>"}}}},init:function(){}});Sfera.Components.create("Page",{presets:["Visibility"],attributes:{title:{type:"string"},visible:{"default":"false"}},init:function(){}});Sfera.Components.create("Label",{presets:["Visibility","Position","Size","Label"],attributes:{label:null,text:{type:"string",update:function(){this.component.element.innerHTML=this.value}}}});Sfera.Components.create("Interface",{presets:["Visibility","Size"],attributes:{skin:{"default":"default",update:function(){Sfera.client.skin=new(Sfera.Skins[Sfera.Utils.capitalize(this.value)])}},zoom:{type:"float",update:function(){if(this.value!=1){var bodyE=document.getElementsByTagName("BODY")[0];var v="scale("+this.value+","+this.value+")";if(Sfera.Device.browser=="IE"){bodyE.style.msTransform=v;bodyE.style.msTransformOrigin="0% 0%"}else{bodyE.style.zoom=this.value*100+"%";bodyE.style.OTransform=v;bodyE.style.MozTransform=v;bodyE.style.WebkitTransformOrigin="0 0";bodyE.style.transformOrigin="0% 0%"}bodyE.style.width="0px";bodyE.style.height="0px"}}}}});Sfera.Custom=new function(){var root=this;this.startupEvent=typeof StartupEvent==="function"?function(){StartupEvent()}:null;this.commandEvent=typeof commandEvent==="function"?function(id,value){return commandEvent(id,value)}:null;this.uiEvent=typeof uiEvent==="function"?function(id,attr,value){return uiEvent(id,attr,value)}:null;this.pageOpenEvent=typeof pageOpenEvent==="function"?function(name){return pageOpenEvent(name)}:null;this.pageCloseEvent=typeof pageCloseEvent==="function"?function(name){return pageCloseEvent(name)}:null;this.pageBackEvent=typeof pageBackEvent==="function"?function(name){return pageBackEvent(name)}:null;function page(id){Sfera.client.showPage(id)}function event(id,value){Sfera.client.sendEvent(id,value,this)}function command(command,callback){Sfera.client.sendCommand(command,this)}function logout(){Sfera.Login.logout()}function login(username,password){Sfera.Login.login(username,password)}this.exec=function(f,id,value){try{var result=eval(f)}catch(e){if(e instanceof SyntaxError){alert(e.message)}else{throw e}}return result===false?false:true}};
//# sourceMappingURL=code.js.map