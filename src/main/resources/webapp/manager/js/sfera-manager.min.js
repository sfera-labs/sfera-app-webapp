/*! sfera-webapp - v0.0.2 */

function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),
l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}function focusElement(a){focusedElement=a,a.focus&&a.focus()}function focusMe(a){focusedElement=a}function blurMe(a){focusedElement=null}function loseFocus(){if(focusedElement){try{focusedElement.blur()}catch(a){}focusedElement=null,window.focus&&window.focus()}}function Animations(){function a(a,c){a.timeout=setTimeout(function(){b(a)},c)}function b(b){if(b){if(b.timeout&&(clearTimeout(b.timeout),b.timeout=null),!b.e)return void j.removeAnimation(b);switch(b.type){case"fade":switch(b.s){case 0:if(b.s=1,b.onFadeIn&&b.onFadeIn(),b.fadeInTime){b.t=Math.floor(b.fadeInTime/g),null!=b.cv?(b.v=b.cv,b.cv=null,b.c=Math.round(b.t*((b.v-b.fadeFrom)/(b.fadeTo-b.fadeFrom)))):b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="inline",a(b,b.waitTime?b.waitTime:g);break}case 1:if(b.fadeInTime&&b.c!=b.t){b.c++,b.v=b.fadeFrom+(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g);break}if(b.v=b.cv?b.cv:b.fadeTo,c(b.e,b.v),b.s=2,b.onFadedIn&&b.onFadedIn(),b.idleTime){a(b,b.idleTime);break}case 2:if(!b.fadeOutTime){j.removeAnimation(b);break}b.s=3,b.c=0,b.t=Math.floor(b.fadeOutTime/g),null!=b.cv&&(b.v=b.cv,b.c=Math.round(b.t*((b.fadeTo-b.v)/(b.fadeTo-b.fadeFrom)))),b.onFadeOut&&b.onFadeOut();case 3:b.c==b.t?(b.v=b.fadeFrom,c(b.e,b.v),b.e.style.display="none",j.removeAnimation(b),b.onFadedOut&&b.onFadedOut()):(b.c++,b.v=b.fadeTo-(b.fadeTo-b.fadeFrom)*b.c/b.t,c(b.e,b.v),a(b,g))}break;case"size":switch(b.s){case 0:b.s=1,b.t=Math.floor(b.a/g)}}}}function c(a,b){b=100==b?99.999:b,a.style.filter="alpha(opacity:"+b+")",a.style.KHTMLOpacity=b/100,a.style.MozOpacity=b/100,a.style.opacity=b/100}function d(a){if(!a)return!1;for(;a.parentNode;)a=a.parentNode;return!!a.body}function e(){m=m.next(4);for(var a=0;a<l.length;a++)d(l[a].e)?l[a].f?f(l[a].e,m%2==0):f(l[a].e,2>m):(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}function f(a,b){a&&browser.setOpacity(a,null==b?null:b?1:.3)}var g=50,h={},i=0,j=this;this.fadeAnimation=function(a,d){if(d){i++;var e=d;if(e.e=a,e.type="fade",e.id=i,e.timeout=null,e.s=0,e.c=0,e.t=0,null==e.fadeFrom&&(e.fadeFrom=0),null==e.fadeTo&&(e.fadeTo=100),e.fadeFrom==e.fadeTo)return c(e.fadeFrom),null;for(var f in h)h[f]&&h[f].e==a&&("fade"==h[f].type&&(e.cv=h[f].v),this.removeAnimation(h[f]));return h["a"+i]=e,b(e),e}},this.sizeAnimation=function(a,c,d,e,f){if(options){i++;var g={e:a,type:"size",id:i,timeout:null,a:d,w:e,h:f,ow:a.offsetWidth,oh:a.offsetHeight};g.s=0,g.t=0;for(var j in h)h[j]&&h[j].e==a&&this.removeAnimation(h[j]);return h["a"+i]=g,b(g),g}},this.removeAnimation=function(a){a.timeout&&(clearTimeout(a.timeout),a.timeout=null),h[a.id]=null,delete h[a.id]};var k=null,l=[],m=0;this.getBlinks=function(){return l},this.setBlink=function(a,b,c){for(var d=0;d<l.length;d++)if(l[d].e==a){f(a,null),l.splice(d,1);break}b&&"false"!=b&&l.push({e:a,f:"fast"==b,r:c}),l.length&&!k?k=setInterval(e,250):!l.length&&k&&(clearInterval(k),k=null)},this.stopAllBlink=function(){for(var a=0;a<l.length;a++)l[a].r||(f(l[a].e,null),l.splice(a,1),a--);!l.length&&k&&(clearInterval(k),k=null)}}function Z(a){return document.getElementById(a)}function r(a){return Math.floor(Math.random()*a)}function f(a){var b=(new Date).getTime(),c=a.x,d=a.y;a.ls||(a.ls=b);var e=b-a.ls,f=e*a.s/100-a.p;return c+=Math.sin(f)*a.a,d+=Math.sin(f)*a.b,{x:c,y:d}}function d(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(f*f+e*e)}function dr(){var a,b,c,e,g,h,i,j,l,m=window.innerWidth,n=window.innerHeight,o=200;try{j=Z("c"),l=j.getContext("2d"),i="undefined"!=typeof j.style.opacity,i&&(j.style.opacity=.3)}catch(q){return}if(l.canvas.width=m,l.canvas.height=n,!p){for(p=[],a=-1;m/o>=a;a++)for(b=-1;n/o>=b;b++)h={x:o*a+r(o),y:o*b+r(o),r:r(10)+4,a:r(13),b:r(13),p:r(100),w:r(1e4),s:r(10)/100,l:[]},p.push(h),k++;for(h=0;k>h;h++)for(a=p[h].x,b=p[h].y,g=h+1;k>g;g++)c=p[g].x,e=p[g].y,d(a,b,c,e)<2*o&&p[h].l.push(p[g])}for(l.strokeStyle=l.fillStyle=i?"#fff":"#7194b8",h=0;k>h;h++){for(a=f(p[h]).x,b=f(p[h]).y,g=0;g<p[h].l.length;g++)c=f(p[h].l[g]).x,e=f(p[h].l[g]).y,l.moveTo(a,b),l.lineTo(c,e);l.stroke(),l.beginPath(),l.arc(a,b,p[h].r,0,2*Math.PI,!1),l.fill()}}var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),
docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){return},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index."+l}),i.push({name:"index_item",path:"index_item."+l}),i.push({name:"component",path:"component."+l}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default});var g=m;j=[];for(var i in Sfera.Components.Classes)a=g.component(Sfera.Components.Classes[i]),a&&(d.push(i),j.push({path:"components/"+i+"."+l,content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",g.toc(d)),j.push({path:"index."+l,content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client;document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}else;}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index."+l}this.id="dv",this.open=!1;this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={},l="md";this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var m=(new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}},new function(){function a(a){l+=a}function b(){return"\n"}function c(){return" "}function d(a){return"**"+a+"**"}function e(a,b,c){return"["+a+"]("+b+")"}function f(a,b){for(var c="\n",d=0;a>d;d++)c+="#";return c+" "+b+"\n\n"}function g(a,b){return""}function h(a){var b=a?"|\n":"";if(a&&m){for(var c=0;m>c;c++)b+="|---";b+="|\n",m=0}return b}function i(a){return"|"+a}function j(a){return m++,"|"+a}var l="",m=0;this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Default")),a(j("Values")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r=m.attributes[p]["default"];a(i(r?r:"")),r="";var s=m.attributes[p].values;if(s&&"null"!=s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}});a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none";this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;
if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN"),h="";for(c=0;c<g.length;c++)h+=(h?"/":"")+f[c],this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+h+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this;manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode;manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode;this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1;this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1;this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){return},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";
if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index."+l}),i.push({name:"index_item",path:"index_item."+l}),i.push({name:"component",path:"component."+l}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default});var g=m;j=[];for(var i in Sfera.Components.Classes)a=g.component(Sfera.Components.Classes[i]),a&&(d.push(i),j.push({path:"components/"+i+"."+l,content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",g.toc(d)),j.push({path:"index."+l,content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index."+l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={},l="md";this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var m=(new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}},new function(){function a(a){l+=a}function b(){return"\n"}function c(){return" "}function d(a){return"**"+a+"**"}function e(a,b,c){return"["+a+"]("+b+")"}function f(a,b){for(var c="\n",d=0;a>d;d++)c+="#";return c+" "+b+"\n\n"}function g(a,b){return""}function h(a){var b=a?"|\n":"";if(a&&m){for(var c=0;m>c;c++)b+="|---";b+="|\n",m=0}return b}function i(a){return"|"+a}function j(a){return m++,"|"+a}var l="",m=0;this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Default")),a(j("Values")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r=m.attributes[p]["default"];a(i(r?r:"")),r="";var s=m.attributes[p].values;if(s&&"null"!=s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}});a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN"),h="";for(c=0;c<g.length;c++)h+=(h?"/":"")+f[c],this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+h+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,
Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index."+l}),i.push({name:"index_item",path:"index_item."+l}),i.push({name:"component",path:"component."+l}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default});var g=m;j=[];for(var i in Sfera.Components.Classes)a=g.component(Sfera.Components.Classes[i]),a&&(d.push(i),j.push({path:"components/"+i+"."+l,content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",g.toc(d)),j.push({path:"index."+l,content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index."+l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={},l="md";this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var m=(new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}},new function(){function a(a){l+=a}function b(){return"\n"}function c(){return" "}function d(a){return"**"+a+"**"}function e(a,b,c){return"["+a+"]("+b+")"}function f(a,b){for(var c="\n",d=0;a>d;d++)c+="#";return c+" "+b+"\n\n"}function g(a,b){return""}function h(a){var b=a?"|\n":"";if(a&&m){for(var c=0;m>c;c++)b+="|---";b+="|\n",m=0}return b}function i(a){return"|"+a}function j(a){return m++,"|"+a}var l="",m=0;this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));
return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Default")),a(j("Values")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r=m.attributes[p]["default"];a(i(r?r:"")),r="";var s=m.attributes[p].values;if(s&&"null"!=s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}});a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN"),h="";for(c=0;c<g.length;c++)h+=(c?"/":"")+f[c],this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+h+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;
""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index."+l}),i.push({name:"index_item",path:"index_item."+l}),i.push({name:"component",path:"component."+l}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default});var g=m;j=[];for(var i in Sfera.Components.Classes)a=g.component(Sfera.Components.Classes[i]),a&&(d.push(i),j.push({path:"components/"+i+"."+l,content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",g.toc(d)),j.push({path:"index."+l,content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index."+l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={},l="md";this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var m=(new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}},new function(){function a(a){l+=a}function b(){return"\n"}function c(){return" "}function d(a){return"**"+a+"**"}function e(a,b,c){return"["+a+"]("+b+")"}function f(a,b){for(var c="\n",d=0;a>d;d++)c+="#";return c+" "+b+"\n\n"}function g(a,b){return""}function h(a){var b=a?"|\n":"";if(a&&m){for(var c=0;m>c;c++)b+="|---";b+="|\n",m=0}return b}function i(a){return"|"+a}function j(a){return m++,"|"+a}var l="",m=0;this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Default")),a(j("Values")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r=m.attributes[p]["default"];a(i(r?r:"")),r="";var s=m.attributes[p].values;if(s&&"null"!=s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}});a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;
this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN"),h="";for(c=0;c<g.length;c++)h+=(c?"/":"")+f[c],this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+h+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){
try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index."+l}),i.push({name:"index_item",path:"index_item."+l}),i.push({name:"component",path:"component."+l}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default});var g=m;j=[];for(var i in Sfera.Components.Classes)a=g.component(Sfera.Components.Classes[i]),a&&(d.push(i),j.push({path:"components/"+i+"."+l,content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",g.toc(d)),j.push({path:"index."+l,content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index."+l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={},l="md";this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var m=(new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}},new function(){function a(a){l+=a}function b(){return"\n"}function c(){return" "}function d(a){return"**"+a+"**"}function e(a,b,c){return"["+a+"]("+b+")"}function f(a,b){for(var c="\n",d=0;a>d;d++)c+="#";return c+" "+b+"\n\n"}function g(a,b){return""}function h(a){var b=a?"|\n":"";if(a&&m){for(var c=0;m>c;c++)b+="|---";b+="|\n",m=0}return b}function i(a){return"|"+a}function j(a){return m++,"|"+a}var l="",m=0;this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Default")),a(j("Values")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r=m.attributes[p]["default"];a(i(r?r:"")),r="";var s=m.attributes[p].values;if(s&&"null"!=s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}});a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);
if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN"),h="";for(c=0;c<g.length;c++)h+=(c?"/":"")+f[c],this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+h+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);
break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index."+l}),i.push({name:"index_item",path:"index_item."+l}),i.push({name:"component",path:"component."+l}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default});var g=m;j=[];for(var i in Sfera.Components.Classes)a=g.component(Sfera.Components.Classes[i]),a&&(d.push(i),j.push({path:"components/"+i+"."+l,content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",g.toc(d)),j.push({path:"index."+l,content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index."+l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={},l="md";this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var m=(new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}},new function(){function a(a){l+=a}function b(){return"\n"}function c(){return" "}function d(a){return"**"+a+"**"}function e(a,b,c){return"["+a+"]("+b+")"}function f(a,b){for(var c="\n",d=0;a>d;d++)c+="#";return c+" "+b+"\n\n"}function g(a,b){return""}function h(a){var b=a?"|\n":"";if(a&&m){for(var c=0;m>c;c++)b+="|---";b+="|\n",m=0}return b}function i(a){return"|"+a}function j(a){return m++,"|"+a}var l="",m=0;this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Default")),a(j("Values")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r=m.attributes[p]["default"];a(i(r?r:"")),r="";var s=m.attributes[p].values;if(s&&"null"!=s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}});a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN"),h="";for(c=0;c<g.length;c++)h+=(c?"/":"")+f[c],this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+h+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null);
},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index."+l}),i.push({name:"index_item",path:"index_item."+l}),i.push({name:"component",path:"component."+l}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default});var g=m;j=[];for(var i in Sfera.Components.Classes)a=g.component(Sfera.Components.Classes[i]),a&&(d.push(i),j.push({path:"components/"+i+"."+l,content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",g.toc(d)),j.push({path:"index."+l,content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index."+l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={},l="md";this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var m=(new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}},new function(){function a(a){l+=a}function b(){return"\n"}function c(){return" "}function d(a){return"**"+a+"**"}function e(a,b,c){return"["+a+"]("+b+")"}function f(a,b){for(var c="\n",d=0;a>d;d++)c+="#";return c+" "+b+"\n\n"}function g(a,b){return""}function h(a){var b=a?"|\n":"";if(a&&m){for(var c=0;m>c;c++)b+="|---";b+="|\n",m=0}return b}function i(a){return"|"+a}function j(a){return m++,"|"+a}var l="",m=0;this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Default")),a(j("Values")),a(j("Description")),
a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r=m.attributes[p]["default"];a(i(r?r:"")),r="";var s=m.attributes[p].values;if(s&&"null"!=s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}});a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN"),h="";for(c=0;c<g.length;c++)h+=(c?"/":"")+f[c],this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+h+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),
!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index.html"}),i.push({name:"index_item",path:"index_item.html"}),i.push({name:"component",path:"component.html"}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default}),j=[];for(var g in Sfera.Components.Classes)a=l.component(Sfera.Components.Classes[g]),a&&(d.push(g),j.push({path:"components/"+g+".html",content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",l.toc(d)),j.push({path:"index.html",content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index.html"}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={};this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var l=new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}};a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",
this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),
document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index.html"}),i.push({name:"index_item",path:"index_item.html"}),i.push({name:"component",path:"component.html"}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default}),j=[];for(var g in Sfera.Components.Classes)a=l.component(Sfera.Components.Classes[g]),a&&(d.push(g),j.push({path:"components/"+g+".html",content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",l.toc(d)),j.push({path:"index.html",content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/cache/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/cache/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index.html"}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={};this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var l=new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}};a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;
var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==g.resType||"gettextpreview"==g.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";if(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f)return void f(a,b?{code:b,descr:e}:null);switch(g.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var h=g.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+h+"</b>) created";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"deletefile":manager.closePopup();var j=g.resID.length,k="file"+(g.resID.length>1?"s":"");c=b?"error deleting "+k+": "+a.error:j+" "+k+" deleted";var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(i.currentPath);break;case"renamefile":case"duplicatefile":var l="renamefile"==g.resType?"renaming":"duplicating",m="renamefile"==g.resType?"renamed":"duplicated",h=g.resID[0].split("/").pop();if(b)c="error "+l+" <b>"+h+"</b>: "+a.error;else{c="<b>"+h+"</b> "+m;var i=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(i.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var j=g.resID.length-1,k="file"+(j>1?"s":""),n="movefiles"==g.resType||"movefilesoverwrite"==g.resType,o=n?"moved":"copied",p=n?"moving":"copying";c=b?"error "+p+" "+k+": "+e:j+" "+k+" "+o+" to <b>"+g.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":
fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var q=d+": "+e+" ("+b+")";manager.showErrorPopup(q)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f,g=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c,d){c||(c=10),f=d;var g="",h=(new Date).getTime(),i=b;switch(e.method="GET",a){case"list":case"refresh_list":g="/api/files/ls?path="+this.encodeFileName(b),g+="&depth=0";break;case"readfile":g="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":i=b[0],g="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":g="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":g="/api/files/rm?";for(var j=0;j<b.length;j++)g+=(j?"&":"")+"path="+this.encodeFileName(b[j]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":g="/api/files/mv?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(g+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":g="/api/files/cp?";for(var j=0;j<b.length-1;j++)g+=(j?"&":"")+"source="+this.encodeFileName(b[j]);g+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(g+="&force=true");break;case"gettextpreview":g="/api/files/read?path="+this.encodeFileName(b),g+="&lines=9"}"GET"==e.method&&(g+="&ts="+h),this.resType=a,this.resID=i,e.open(g,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){Sfera.Components.boot(),i.push({name:"index",path:"index.html"}),i.push({name:"index_item",path:"index_item.html"}),i.push({name:"component",path:"component.html"}),d()}function b(){var a,b,c="",d=[];Sfera.client||(b=!0,Sfera.client={skin:new Sfera.Skins.Default}),j=[];for(var g in Sfera.Components.Classes)a=l.component(Sfera.Components.Classes[g]),a&&(d.push(g),j.push({path:"components/"+g+".html",content:k.component.replace("%component",a)}),c+=a);c=k.index.replace("%toc",l.toc(d)),j.push({path:"index.html",content:c}),h.innerHTML="<iframe></iframe>",f=h.childNodes[0],e(),b&&delete Sfera.client,document.getElementById("bg")}function c(a,b){var c=i.pop();k[c.name]=a.content,d()}function d(){if(i.length){var a=i.last();files.load("readfile",["/webapp/manager/doc/_templates/"+a.path],10,c)}}function e(){if(j.length){var a=j.pop();files.load("writefile",["/webapp/manager/doc/"+a.path,a.content],10,e)}else f.src="doc/index.html"}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var f,g=document.getElementById("dv_toolbar"),h=document.getElementById("dv_docPanel"),i=(document.getElementById("dv_editorHeaderLabel"),[]),j=[],k={};this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.open=!0,this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,d=36,e=a-c;g.style.left=c-1+"px",g.style.width=e+1+"px";var f=1,i=5+f,j=7,k=Math.round((a-3*j-4*i)/2),l=b-d-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var e=a-2*i-2*j;h.style.left=j+"px",h.style.top=d+j+"px",h.style.width=e+"px",h.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"};var l=new function(){function a(a){l+=a}function b(){return"<br />"}function c(){return"&nbsp;"}function d(a){return"<b>"+a+"</b>"}function e(a,b,c){return c=c?' target="'+c+'"':"",'<a href="'+b+'"'+c+">"+a+"</a>"}function f(a,b){return"<h"+a+">"+b+"</h"+a+">"}function g(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function h(a){return(a?"</":"<")+"tr>"}function i(a){return"<td>"+a+"</td>"}function j(a){return"<th>"+a+"</th>"}var l="";this.toc=function(b){l="";for(var c=0;c<b.length;c++)a(k.index_item.replace("%item",b[c]).replace("%url","components/"+b[c]+".html"));return l},this.component=function(k){l="";var m=new k({doc:!0});if(m.doc&&m.doc.hidden)return"";a(f(1,m.type)),m.doc&&m.doc.descr&&a(m.doc.descr);for(n in m.subComponents){a(f(2,"Sub components"));break}for(var n in m.subComponents){var o=m.subComponents[n].type;a(_sub+c()),a(e("["+o+"]","#"+o)),a(b())}a(f(2,"Attributes")),a(g(0,"docTable")),a(h()),a(j("Name")),a(j("Type")),a(j("Value")),a(j("Default")),a(j("Description")),a(h(1));for(var p in m.attributes){a(h());var q=m.attributes[p];a(i(d(p))),a(i(q.type));var r="",s=m.attributes[p].values;if(s){if(Sfera.Utils.isFunction(s))try{s=s()}catch(t){s=[]}Sfera.Utils.isArray(s)&&(r+=s.join(", "))}a(i(m.attributes[p]["default"])),a(i(r)),a(i(q.doc&&q.doc.descr?q.doc.descr:"")),a(h(1))}return a(g(1)),l}};a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline";
}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==f.resType||"gettextpreview"==f.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";switch(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var g=f.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+g+"</b>) created";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"deletefile":manager.closePopup();var i=f.resID.length,j="file"+(f.resID.length>1?"s":"");c=b?"error deleting "+j+": "+a.error:i+" "+j+" deleted";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"renamefile":case"duplicatefile":var k="renamefile"==f.resType?"renaming":"duplicating",l="renamefile"==f.resType?"renamed":"duplicated",g=f.resID[0].split("/").pop();if(b)c="error "+k+" <b>"+g+"</b>: "+a.error;else{c="<b>"+g+"</b> "+l;var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(h.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var i=f.resID.length-1,j="file"+(i>1?"s":""),m="movefiles"==f.resType||"movefilesoverwrite"==f.resType,n=m?"moved":"copied",o=m?"moving":"copying";c=b?"error "+o+" "+j+": "+e:i+" "+j+" "+n+" to <b>"+f.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var p=d+": "+e+" ("+b+")";manager.showErrorPopup(p)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c){c||(c=10);var d="",f=(new Date).getTime(),g=b;switch(e.method="GET",a){case"list":case"refresh_list":d="/api/files/ls?path="+this.encodeFileName(b),d+="&depth=0";break;case"readfile":d="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":g=b[0],d="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":d="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":d="/api/files/rm?";for(var h=0;h<b.length;h++)d+=(h?"&":"")+"path="+this.encodeFileName(b[h]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":d="/api/files/mv?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(d+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":d="/api/files/cp?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(d+="&force=true");break;case"gettextpreview":d="/api/files/read?path="+this.encodeFileName(b),d+="&lines=9"}"GET"==e.method&&(d+="&ts="+f),this.resType=a,this.resID=g,e.open(d,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){}function b(){var a="";e.innerHTML="<iframe>"+a+"</iframe>";var b=e.childNodes[0].contentWindow.document;for(var d in Sfera.Components.Classes)"_"!=d[0]&&(a+=c(Sfera.Components.Classes[d]));b.open(),b.write(a),b.close()}function c(a){function b(a){l+=a}function c(){return"<br />"}function d(){return"&nbsp;"}function e(a){return"<b>"+a+"</b>"}function f(a,b){return'<a href="'+b+'">'+a+"</a>"}function g(a,b){return"<h"+a+">"+b+"</h"+a+">"}function h(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function i(a){return(a?"</":"<")+"tr>"}function j(a){return"<td>"+a+"</td>"}function k(a){return"<th>"+a+"</th>"}var l="",m=new a({doc:!0});b(g(1,f(m.type,"#"+m.type)));try{b(m.doc)}catch(n){console.log(n)}for(o in m.subComponents){b(g(2,"Sub components"));break}for(var o in m.subComponents){var p=m.subComponents[o].type;b(_sub+d()),b(f("["+p+"]","#"+p)),b(c())}b(g(2,"Attributes")),b(h(0,"docTable")),b(i()),b(k("Name")),b(k("Type")),b(k("Values")),b(k("Description")),b(i(1));for(var q in m.attributes){b(i());var r=m.attributes[q];b(j(e(q))),b(j(r.type));var s="",t=m.attributes[q].values;if(t){if(Sfera.Utils.isFunction(t))try{t=t()}catch(n){t=[]}if(Sfera.Utils.isArray(t)){for(;s.length<35;)s+=" ";s+="<"+t.join("|")+">"}}b(j(s)),b(j(r.doc?r.doc:"")),b(i(1))}return b(h(1)),b('<link rel="stylesheet" href="css/style.css">'),l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var d=document.getElementById("dv_toolbar"),e=document.getElementById("dv_docPanel");document.getElementById("dv_editorHeaderLabel"),this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,g=a-c;d.style.left=c-1+"px",d.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var g=a-2*i-2*j;e.style.left=j+"px",e.style.top=f+j+"px",e.style.width=g+"px",e.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"},a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];
var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),
this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==f.resType||"gettextpreview"==f.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";switch(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var g=f.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+g+"</b>) created";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"deletefile":manager.closePopup();var i=f.resID.length,j="file"+(f.resID.length>1?"s":"");c=b?"error deleting "+j+": "+a.error:i+" "+j+" deleted";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"renamefile":case"duplicatefile":var k="renamefile"==f.resType?"renaming":"duplicating",l="renamefile"==f.resType?"renamed":"duplicated",g=f.resID[0].split("/").pop();if(b)c="error "+k+" <b>"+g+"</b>: "+a.error;else{c="<b>"+g+"</b> "+l;var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(h.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var i=f.resID.length-1,j="file"+(i>1?"s":""),m="movefiles"==f.resType||"movefilesoverwrite"==f.resType,n=m?"moved":"copied",o=m?"moving":"copying";c=b?"error "+o+" "+j+": "+e:i+" "+j+" "+n+" to <b>"+f.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var p=d+": "+e+" ("+b+")";manager.showErrorPopup(p)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c){c||(c=10);var d="",f=(new Date).getTime(),g=b;switch(e.method="GET",a){case"list":case"refresh_list":d="/api/files/ls?path="+this.encodeFileName(b),d+="&depth=0";break;case"readfile":d="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":g=b[0],d="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":d="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":d="/api/files/rm?";for(var h=0;h<b.length;h++)d+=(h?"&":"")+"path="+this.encodeFileName(b[h]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":d="/api/files/mv?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(d+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":d="/api/files/cp?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(d+="&force=true");break;case"gettextpreview":d="/api/files/read?path="+this.encodeFileName(b),d+="&lines=9"}"GET"==e.method&&(d+="&ts="+f),this.resType=a,this.resID=g,e.open(d,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){}function b(){var a="";e.innerHTML="<iframe>"+a+"</iframe>";var b=e.childNodes[0].contentWindow.document;for(var d in Sfera.Components.Classes)"_"!=d[0]&&(a+=c(Sfera.Components.Classes[d]));b.open(),b.write(a),b.close()}function c(a){function b(a){l+=a}function c(){return"<br />"}function d(){return"&nbsp;"}function e(a){return"<b>"+a+"</b>"}function f(a,b){return'<a href="'+b+'">'+a+"</a>"}function g(a,b){return"<h"+a+">"+b+"</h"+a+">"}function h(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function i(a){return(a?"</":"<")+"tr>"}function j(a){return"<td>"+a+"</td>"}function k(a){return"<th>"+a+"</th>"}var l="",m=new a({doc:!0});b(g(1,f(m.type,"#"+m.type)));try{b(m.doc)}catch(n){console.log(n)}for(o in m.subComponents){b(g(2,"Sub components"));break}for(var o in m.subComponents){var p=m.subComponents[o].type;b(_sub+d()),b(f("["+p+"]","#"+p)),b(c())}b(g(2,"Attributes")),b(h(0,"docTable")),b(i()),b(k("Name")),b(k("Type")),b(k("Values")),b(k("Description")),b(i(1));for(var q in m.attributes){b(i());var r=m.attributes[q];b(j(e(q))),b(j(r.type));var s="",t=m.attributes[q].values;if(t){if(Sfera.Utils.isFunction(t))try{t=t()}catch(n){t=[]}if(Sfera.Utils.isArray(t)){for(;s.length<35;)s+=" ";s+="<"+t.join("|")+">"}}b(j(s)),b(j(r.doc?r.doc:"")),b(i(1))}return b(h(1)),b('<link rel="stylesheet" href="css/style.css">'),l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var d=document.getElementById("dv_toolbar"),e=document.getElementById("dv_docPanel");document.getElementById("dv_editorHeaderLabel"),this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,g=a-c;d.style.left=c-1+"px",d.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var g=a-2*i-2*j;e.style.left=j+"px",e.style.top=f+j+"px",e.style.width=g+"px",e.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"},a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){
var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",
n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==f.resType||"gettextpreview"==f.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";switch(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var g=f.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+g+"</b>) created";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"deletefile":manager.closePopup();var i=f.resID.length,j="file"+(f.resID.length>1?"s":"");c=b?"error deleting "+j+": "+a.error:i+" "+j+" deleted";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"renamefile":case"duplicatefile":var k="renamefile"==f.resType?"renaming":"duplicating",l="renamefile"==f.resType?"renamed":"duplicated",g=f.resID[0].split("/").pop();if(b)c="error "+k+" <b>"+g+"</b>: "+a.error;else{c="<b>"+g+"</b> "+l;var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(h.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var i=f.resID.length-1,j="file"+(i>1?"s":""),m="movefiles"==f.resType||"movefilesoverwrite"==f.resType,n=m?"moved":"copied",o=m?"moving":"copying";c=b?"error "+o+" "+j+": "+e:i+" "+j+" "+n+" to <b>"+f.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var p=d+": "+e+" ("+b+")";manager.showErrorPopup(p)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c){c||(c=10);var d="",f=(new Date).getTime(),g=b;switch(e.method="GET",a){case"list":case"refresh_list":d="/api/files/ls?path="+this.encodeFileName(b),d+="&depth=0";break;case"readfile":d="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":g=b[0],d="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":d="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":d="/api/files/rm?";for(var h=0;h<b.length;h++)d+=(h?"&":"")+"path="+this.encodeFileName(b[h]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":d="/api/files/mv?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(d+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":d="/api/files/cp?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(d+="&force=true");break;case"gettextpreview":d="/api/files/read?path="+this.encodeFileName(b),d+="&lines=9"}"GET"==e.method&&(d+="&ts="+f),this.resType=a,this.resID=g,e.open(d,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){}function b(){var a="";e.innerHTML="<iframe>"+a+"</iframe>";var b=e.childNodes[0].contentWindow.document;for(var d in Sfera.Components.Classes)"_"!=d[0]&&(a+=c(Sfera.Components.Classes[d]));b.open(),b.write(a),b.close()}function c(a){function b(a){l+=a}function c(){return"<br />"}function d(){return"&nbsp;"}function e(a){return"<b>"+a+"</b>"}function f(a,b){return'<a href="'+b+'">'+a+"</a>"}function g(a,b){return"<h"+a+">"+b+"</h"+a+">"}function h(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function i(a){return(a?"</":"<")+"tr>"}function j(a){return"<td>"+a+"</td>"}function k(a){return"<th>"+a+"</th>"}var l="",m=new a({doc:!0});b(g(1,f(m.type,"#"+m.type)));try{b(m.doc)}catch(n){console.log(n)}for(o in m.subComponents){b(g(2,"Sub components"));break}for(var o in m.subComponents){var p=m.subComponents[o].type;b(_sub+d()),b(f("["+p+"]","#"+p)),b(c())}b(g(2,"Attributes")),b(h(0,"docTable")),b(i()),b(k("Name")),b(k("Type")),b(k("Values")),b(k("Description")),b(i(1));for(var q in m.attributes){b(i());var r=m.attributes[q];b(j(e(q))),b(j(r.type));var s="",t=m.attributes[q].values;if(t){if(Sfera.Utils.isFunction(t))try{t=t()}catch(n){t=[]}if(Sfera.Utils.isArray(t)){for(;s.length<35;)s+=" ";s+="<"+t.join("|")+">"}}b(j(s)),b(j(r.doc?r.doc:"")),b(i(1))}return b(h(1)),b('<link rel="stylesheet" href="css/style.css">'),l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var d=document.getElementById("dv_toolbar"),e=document.getElementById("dv_docPanel");document.getElementById("dv_editorHeaderLabel"),this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,g=a-c;d.style.left=c-1+"px",d.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var g=a-2*i-2*j;e.style.left=j+"px",e.style.top=f+j+"px",e.style.width=g+"px",e.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"},a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",
this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==f.resType||"gettextpreview"==f.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";switch(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var g=f.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+g+"</b>) created";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"deletefile":manager.closePopup();var i=f.resID.length,j="file"+(f.resID.length>1?"s":"");c=b?"error deleting "+j+": "+a.error:i+" "+j+" deleted";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"renamefile":case"duplicatefile":var k="renamefile"==f.resType?"renaming":"duplicating",l="renamefile"==f.resType?"renamed":"duplicated",g=f.resID[0].split("/").pop();if(b)c="error "+k+" <b>"+g+"</b>: "+a.error;else{c="<b>"+g+"</b> "+l;var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(h.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var i=f.resID.length-1,j="file"+(i>1?"s":""),m="movefiles"==f.resType||"movefilesoverwrite"==f.resType,n=m?"moved":"copied",o=m?"moving":"copying";c=b?"error "+o+" "+j+": "+e:i+" "+j+" "+n+" to <b>"+f.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var p=d+": "+e+" ("+b+")";manager.showErrorPopup(p)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c){c||(c=10);var d="",f=(new Date).getTime(),g=b;switch(e.method="GET",a){case"list":case"refresh_list":d="/api/files/ls?path="+this.encodeFileName(b),d+="&depth=0";break;case"readfile":d="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":g=b[0],d="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":d="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":d="/api/files/rm?";for(var h=0;h<b.length;h++)d+=(h?"&":"")+"path="+this.encodeFileName(b[h]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":d="/api/files/mv?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(d+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":d="/api/files/cp?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(d+="&force=true");break;case"gettextpreview":d="/api/files/read?path="+this.encodeFileName(b),d+="&lines=9"}"GET"==e.method&&(d+="&ts="+f),this.resType=a,this.resID=g,e.open(d,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){}function b(){var a="";e.innerHTML="<iframe>"+a+"</iframe>";var b=e.childNodes[0].contentWindow.document;for(var d in Sfera.Components.Classes)"_"!=d[0]&&(a+=c(Sfera.Components.Classes[d]));b.open(),b.write(a),b.close()}function c(a){function b(a){l+=a}function c(){return"<br />"}function d(){return"&nbsp;"}function e(a){return"<b>"+a+"</b>"}function f(a,b){return'<a href="'+b+'">'+a+"</a>"}function g(a,b){return"<h"+a+">"+b+"</h"+a+">"}function h(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function i(a){return(a?"</":"<")+"tr>"}function j(a){return"<td>"+a+"</td>"}function k(a){return"<th>"+a+"</th>"}var l="",m=new a({doc:!0});b(g(1,f(m.type,"#"+m.type)));try{b(m.doc)}catch(n){console.log(n)}for(o in m.subComponents){b(g(2,"Sub components"));break}for(var o in m.subComponents){var p=m.subComponents[o].type;b(_sub+d()),b(f("["+p+"]","#"+p)),b(c())}b(g(2,"Attributes")),b(h(0,"docTable")),b(i()),b(k("Name")),b(k("Type")),b(k("Values")),b(k("Description")),b(i(1));for(var q in m.attributes){b(i());var r=m.attributes[q];b(j(e(q))),b(j(r.type));var s="",t=m.attributes[q].values;if(t){if(Sfera.Utils.isFunction(t))try{t=t()}catch(n){t=[]}if(Sfera.Utils.isArray(t)){for(;s.length<35;)s+=" ";s+="<"+t.join("|")+">"}}b(j(s)),b(j(r.doc?r.doc:"")),b(i(1))}return b(h(1)),b('<link rel="stylesheet" href="css/style.css">'),l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var d=document.getElementById("dv_toolbar"),e=document.getElementById("dv_docPanel");document.getElementById("dv_editorHeaderLabel"),this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,g=a-c;d.style.left=c-1+"px",d.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var g=a-2*i-2*j;e.style.left=j+"px",e.style.top=f+j+"px",e.style.width=g+"px",e.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"},a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,
La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),
8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};var files,fileManager,textEditor,systemConsole,docViewer,focusedElement;Sfera.Manager=function(a){function b(a){return t.apps[a.id]=a,a}function c(a){switch(json=JSON.parse(a),json.type){case"console":systemConsole.output(json.output);break;case"event":json.files&&fileManager.onWSMessage(json)}}function d(){t.cPopup.contentE.style.display="block",k.style.display="inline",t.adjustPopup();for(var a in t.cPopup.data.input){focusElement(t.cPopup.data.input[a]);break}t.cPopup.data.div.closeBt.style.display=t.cPopup.closeBt?"inline":"none"}function e(a){var b={};b.div={},b.input={},b.select={};var c,d;for(c=a.getElementsByTagName("div"),d=0;d<c.length;d++)b.div[c[d].getAttribute("name")]=c[d];for(c=a.getElementsByTagName("input"),d=0;d<c.length;d++){for(var e=c[d].getAttribute("name"),f="";b.input[e+f];)f+="x";b.input[e+f]=c[d]}for(c=a.getElementsByTagName("select"),d=0;d<c.length;d++)b.select[c[d].getAttribute("name")]=c[d];return b}function f(){for(var a,b,c=document.getElementById("popup-appswitch"),d=0;a=c.getElementsByTagName("div")[d];d++)if(b=a.getAttribute("name"))switch(b){case"content":m=a;break;case"seAppBt":q.se=a;break;case"adAppBt":q.ad=a;break;case"weAppBt":q.we=a;break;case"peAppBt":q.pe=a;break;case"fmAppBt":q.fm=a;break;case"sbAppBt":q.sb=a;break;case"lvAppBt":q.lv=a;break;case"smAppBt":q.sm=a;break;case"kuAppBt":q.ku=a;break;case"buAppBt":q.bu=a;break;case"huAppBt":q.hu=a;break;case"sep1":q[-1]=a;break;case"sep2":q[-2]=a;break;case"sep3":q[-3]=a}}function g(){u.e=document.getElementById("quickAppsPanel");for(var a=u.e.getElementsByTagName("div"),b="",c=0;c<a.length;c++)"quickAppsButton"==a[c].className&&(b=a[c].getAttribute("name"),u.buttonsE[b]=a[c]);u.buttonsIds=u.fixedAppsIds.clone(),h()}function h(){for(;u.e.childNodes.length;)u.e.removeChild(u.e.childNodes[0]);if(-1!=u.cId){for(var a,b=0;b<u.buttonsIds.length;b++)a=u.buttonsE[u.buttonsIds[b]],u.e.appendChild(a),a.style.opacity=b==u.cId?"1":"0.5";t.adjustPanels()}}var i=5e3;this.viewportWidth=0,this.viewportHeight=0;var j=document.getElementById("popupAreaContents"),k=document.getElementById("popupFrame"),l=document.getElementById("popupBg");this.cPopup=null,this.popupStack=[];var m,n="",o=document.getElementById("fm_editPopup"),p=document.getElementById("te_warningsPopup"),q=(document.getElementById("toolbarArrow"),[]);this.tempAreaE=document.getElementById("tempArea");var r=0,s=0;this.cApp="",this.apps={},this.reloading=!1;var t=this,u={e:document.getElementById("quickAppsPanel"),buttonsE:[],buttonsIds:[],fixedAppsIds:["pe","fm","lv"],cId:-1};this.boot=function(){f(),g(),this.initEvents(document.getElementById("manager")),animations=new Animations,files=new Sfera.Manager.Files,fileManager=b(new Sfera.Manager.Apps.FileManager),textEditor=b(new Sfera.Manager.Apps.TextEditor),systemConsole=b(new Sfera.Manager.Apps.SystemConsole),docViewer=b(new Sfera.Manager.Apps.DocViewer),window.onresize=this.onResize.bind(this),this.onResize(),this.showAppsPopup(),Sfera.Net.boot(),Sfera.Net.wsOpen(),Sfera.Net.onMessage.add(c)},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),this.deselect()},this.deselect=function(){try{document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),document.blur&&document.blur()}catch(a){}},this.onResize=function(){var a,b;window.innerWidth?(a=window.innerWidth,b=window.innerHeight):document.documentElement&&document.documentElement.clientWidth?(a=document.documentElement.clientWidth,b=document.documentElement.clientHeight):document.body.clientWidth?(a=document.body.clientWidth,b=document.body.clientHeight):(a=0,b=0),this.adjustLayout(a,b)},this.adjustLayout=function(a,b){a&&b&&(this.viewportWidth=a,this.viewportHeight=b),this.cApp&&this.apps[this.cApp].adjustLayout(),this.adjustPopup(),this.adjustToolbar(),this.adjustPanels()},this.adjustOrientation=function(a){this.closeToolbarPopup()},this.adjustToolbar=function(){},this.adjustPopup=function(){if(this.viewportWidth&&this.viewportHeight&&(vw=this.viewportWidth,vh=this.viewportHeight,l.style.width=vw+"px",l.style.height=vh+"px",this.cPopup)){var a=this.cPopup.contentE.offsetWidth,b=this.cPopup.contentE.offsetHeight;k.style.width=a+"px",k.style.height=b+"px",this.cPopup.contentE.style.left=k.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),this.cPopup.contentE.style.top=k.style.top=c+"px"}},this.adjustPanels=function(){if(this.viewportWidth&&this.viewportHeight){vw=this.viewportWidth,vh=this.viewportHeight;var a=u.e.offsetWidth,b=u.e.offsetHeight;u.e.style.left=Math.round(vw/2-a/2)+"px";var c=Math.round(vh/2-b/2);c>300&&(c=300),c+=5,u.e.style.top=c+"px"}},this.formatFS=function(a){if(void 0==a)return"";var b=5,c=a,d=c+"",e=d.split(".");e[0].length>=b&&e[1]&&(c=Math.round(c),d=c+"");var f="";c/=1e3,f="K",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="M",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="G",d=c+"",d.length>b&&c>1e3&&(c/=1e3,f="T",d=c+"")));var g=d.indexOf(".");if(g>-1){if(e=d.split("."),e[0].length>=b&&e[1])c=Math.round(c);else{var h=3-e[0].length,i=0==h?1:1==h?10:100;c=Math.round(c*i)/i}d=c+""}return d+" "+f+"B"},this.formatDate=function(a){return a.replace(/-/g,"/").replace("T"," ").replace("Z","")},this.initEvents=function(a){function b(a){Sfera.Device.touch?a.ontouchdown||(a.ontouchdown=new Function("return false;")):a.onmousedown||(a.onmousedown=new Function("return false;"))}function c(a){if(a.className&&i.test(a.className)){var b=a.getAttribute("data-onclick"),c=a.getAttribute("data-ondown"),d=a.getAttribute("data-onover"),e=a.getAttribute("data-onout");if(null==b&&null==c&&null==d&&null==e)return;new Sfera.UI.Button(a,{onclick:b,ondown:c,onover:d,onout:e}),h++}}function d(a){}function e(a){}var f,g,h=0,i=/[mc].*?Button/;for(g=0;f=a.getElementsByTagName("img")[g];g++)b(f);for("IMG"==a.nodeName&&b(a),g=0;f=a.getElementsByTagName("div")[g];g++)c(f);for("DIV"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("span")[g];g++)c(f);for("SPAN"==a.nodeName&&c(a),g=0;f=a.getElementsByTagName("input")[g];g++)d(f);for("DIV"==a.nodeName&&d(a),g=0;f=a.getElementsByTagName("label")[g];g++)e(f);"LABEL"==a.nodeName&&e(a)},this.getDivSize=function(a){var b=a.cloneNode(!0);this.tempAreaE.style.position="absolute",this.tempAreaE.style.display="inline",this.tempAreaE.appendChild(b);var c=b.offsetWidth,d=b.offsetHeight;return this.tempAreaE.innerHTML="",this.tempAreaE.style.display="none",{w:c,h:d}},this.switchApp=function(a,b){if("fm"==a&&textEditor.open&&!textEditor.closing&&(a="te"),a==this.cApp)return void this.closePopup();if(this.closeToolbarPopup(),this.closePopups(),this.cApp=a,a?this.apps[a].start(b):this.hideOtherApps(),-1==u.buttonsIds.indexOf(this.cApp)&&-1==u.fixedAppsIds.indexOf(this.cApp))if(u.buttonsIds.length<5)u.buttonsIds.push(this.cApp);else for(var c=u.buttonsIds.length-1;c>=0;c--)if(-1==u.fixedAppsIds.indexOf(u.buttonsIds[c])){u.buttonsIds[c]=this.cApp;break}for(var c=0;c<u.buttonsIds.length;c++)if(u.buttonsIds[c]==this.cApp){u.buttonsIds.splice(0,0,u.buttonsIds.splice(c,1)[0]);break}},this.hideOtherApps=function(a){var b;for(var c in this.apps)b=this.apps[c],b.open&&b!=a&&b.hide()},this.restartServer=function(a){a?(this.closePopup(),this.openPopup("waitrestart",!1),files.load("restart")):this.openPopup("restart",!0)},this.openPopup=function(a,b,c,f){if(this.cPopup){if(this.cPopup.id==a)return;this.cPopup.contentE.style.display="none",this.popupStack.push(this.cPopup)}loseFocus(),this.cPopup={id:a,closeBt:b,onClose:c},this.cPopup.contentE=document.getElementById("popup-"+a),this.cPopup.data=e(this.cPopup.contentE),f||(j.style.display="block"),d()},this.showBlack=function(){this.closePopups(),j.style.display="block",k.style.display="none"},this.closePopup=function(a){if(this.cPopup){loseFocus();var b=this.cPopup;if(this.cPopup=null,!a){for(var c in b.data.input)b.data.input[c].value="";for(var c in b.data.select)b.data.select[c].selectedIndex=0}if(b.contentE.style.display="none",b.onClose&&b.onClose(),this.popupStack.length)this.cPopup=this.popupStack.pop(),d();else switch(j.style.display="none",this.cApp){case"te":textEditor.focus();break;case"fm":fileManager.focus();break;case"sb":statusBrowser.focus();break;case"lv":logViewer.focus();break;case"sm":systemMonitor.focus()}}},this.closePopups=function(){for(;this.cPopup;)this.closePopup()},this.showAppsPopup=function(a){this.closePopups(),this.openPopup("appswitch",a),this.adjustPopup()},this.showErrorPopup=function(a){this.openPopup("error",!1),this.cPopup.data.div.e.innerHTML=a,this.adjustPopup()},this.showLoadingPopup=function(){this.openPopup("loading",!1),this.adjustPopup()},this.showSavingPopup=function(){this.openPopup("saving",!1),this.adjustPopup()},this.showLoginPopup=function(){t.cPopup&&"login"==t.cPopup.id||(t.closePopups(),t.clearNotice(),t.switchApp(""),t.openPopup("login",!1),login.start())},this.showQuickAppsPanel=function(){(!this.cPopup||this.cPopup.closeBt&&"appswitch"!=this.cPopup.id)&&(-1!=u.cId?u.cId=u.cId.next(u.buttonsIds.length):(u.cId=this.cApp?1:0,u.e.style.display="inline"),h())},this.hideQuickAppsPanel=function(a){return-1==u.cId?!1:(a||this.switchApp(u.buttonsIds[u.cId]),u.cId=-1,u.e.style.display="none",h(),!0)},this.showToolbarPopup=function(a,b){""==a?b=!0:null==b&&(b=n!=a),document.getElementById("fm_toolbarToolsBt").btObj.setAttribute("selected",1==b&&"fm_edit"==a),(b||n==a)&&(b||n!=a||(a=""),n!=a&&(o.style.display="fm_edit"==a?"inline":"none",p.style.display="te_warnings"==a?"inline":"none",n=a,this.adjustToolbar()))},this.closeToolbarPopup=function(){this.showToolbarPopup("")},this.showNotice=function(a,b){clearTimeout(r),document.getElementById("notice").innerHTML=a,document.getElementById("noticePanel").style.display="inline",0==s&&animations.fadeAnimation(document.getElementById("noticePanel"),{fadeInTime:300}),s=1,null==b&&(b=i),b&&(r=setTimeout(function(){manager.clearNotice()},b))},this.clearNotice=function(a){clearTimeout(r),s=0,1==a?(document.getElementById("notice").innerHTML="",document.getElementById("noticePanel").style.display="none"):animations.fadeAnimation(document.getElementById("noticePanel"),{fadeOutTime:1500})}},Sfera.Manager.Apps={},Sfera.Manager.Files=function(){function a(){e.onLoaded=b,e.onError=c}function b(){var a;a="readfile"==f.resType||"gettextpreview"==f.resType?{content:this.getResponseText()}:this.getResponseJSON(),d(a,0)}function c(a){var b=this.getResponseJSON();d(b,a)}function d(a,b){var c="",d="",e="";switch(b&&(!manager.cPopup||"saving"!=manager.cPopup.id&&"loading"!=manager.cPopup.id||manager.closePopup(),manager.clearNotice(),e=a?a.error:"",e&&(e=e[0].toLowerCase()+e.substr(1)),d="Error loading "+files.resType,files.resID&&(d+=", "+files.resID)),f.resType){case"list":b||fileManager.onList(a.result);break;case"refresh_list":b||fileManager.refreshFolder(a.result);break;case"readfile":b||"te"!=manager.cApp||textEditor.onFileRead(a.content);break;case"writefile":b||"te"!=manager.cApp||textEditor.onFileSaved(a);break;case"newfolder":manager.closePopup();var g=f.resID.split("/").pop();c=b?"error creating new folder: "+err:"new folder (<b>"+g+"</b>) created";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"deletefile":manager.closePopup();var i=f.resID.length,j="file"+(f.resID.length>1?"s":"");c=b?"error deleting "+j+": "+a.error:i+" "+j+" deleted";var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.browseTo(h.currentPath);break;case"renamefile":case"duplicatefile":var k="renamefile"==f.resType?"renaming":"duplicating",l="renamefile"==f.resType?"renamed":"duplicated",g=f.resID[0].split("/").pop();if(b)c="error "+k+" <b>"+g+"</b>: "+a.error;else{c="<b>"+g+"</b> "+l;var h=fileManager.popupMode?fileManager.popupData:fileManager;fileManager.selectItem(-1),fileManager.browseTo(h.currentPath)}break;case"movefiles":case"movefilesoverwrite":case"copyfiles":case"copyfilesoverwrite":var i=f.resID.length-1,j="file"+(i>1?"s":""),m="movefiles"==f.resType||"movefilesoverwrite"==f.resType,n=m?"moved":"copied",o=m?"moving":"copying";c=b?"error "+o+" "+j+": "+e:i+" "+j+" "+n+" to <b>"+f.resID.last()+"</b>","target file already exists"==e&&manager.openPopup("overwritefiles",!0);break;case"gettextpreview":fileManager.updateTextPreview(a.content)}if(c&&(manager.showNotice(c),d=""),d){var p=d+": "+e+" ("+b+")";manager.showErrorPopup(p)}}var e=new Sfera.Net.Request;this.resID="",this.resType="";var f=this;this.encodeFileName=function(a){return""==a&&(a="."),a=encodeURIComponent(a),a.replace(/\*/g,"%2A")},this.load=function(a,b,c){c||(c=10);var d="",f=(new Date).getTime(),g=b;switch(e.method="GET",a){case"list":case"refresh_list":d="/api/files/ls?path="+this.encodeFileName(b),d+="&depth=0";break;case"readfile":d="/api/files/read?path="+this.encodeFileName(b);break;case"writefile":g=b[0],d="/api/files/write",e.addData("path",b[0]),e.addData("content",b[1]),e.method="POST";break;case"newfolder":d="/api/files/mkdir?path="+this.encodeFileName(b);break;case"deletefile":d="/api/files/rm?";for(var h=0;h<b.length;h++)d+=(h?"&":"")+"path="+this.encodeFileName(b[h]);break;case"renamefile":case"movefiles":case"movefilesoverwrite":d="/api/files/mv?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"movefilesoverwrite"==a&&(d+="&force=true");break;case"duplicatefile":case"copyfiles":case"copyfilesoverwrite":d="/api/files/cp?";for(var h=0;h<b.length-1;h++)d+=(h?"&":"")+"source="+this.encodeFileName(b[h]);d+="&target="+this.encodeFileName(b.last()),"copyfilesoverwrite"==a&&(d+="&force=true");break;case"gettextpreview":d="/api/files/read?path="+this.encodeFileName(b),d+="&lines=9"}"GET"==e.method&&(d+="&ts="+f),this.resType=a,this.resID=g,e.open(d,c)},this.del=function(a){var b="."+(new Date).getTime(),c="/x/files?dr"+b;c+="*"+this.encodeFileName(a),this.resType="delproj",this.resID=a,e.open(c)},this.getSkin=function(a){var b=a.indexOf("(#skin "),c=b+7,d=a.indexOf(")",c);return a.substr(c,d-c)},a()};var tid=0,p,k=0;window.addEventListener("resize",function(){clearTimeout(tid),tid=setTimeout(dr,100)}),window.addEventListener("load",function(){Z("bg").innerHTML="<canvas id='c'></canvas>",setInterval(dr,50)}),Sfera.Manager.Apps.DocViewer=function(){function a(){}function b(){var a="";e.innerHTML="<iframe>"+a+"</iframe>";var b=e.childNodes[0].contentWindow.document;for(var d in Sfera.Components.Classes)"_"!=d[0]&&(a+=c(Sfera.Components.Classes[d]));b.open(),b.write(a),b.close()}function c(a){function b(a){l+=a}function c(){return"<br />"}function d(){return"&nbsp;"}function e(a){return"<b>"+a+"</b>"}function f(a,b){return'<a href="'+b+'">'+a+"</a>"}function g(a,b){return"<h"+a+">"+b+"</h"+a+">"}function h(a,b){return(a?"</":"<")+"table"+(a||!b?">":" class='"+b+"'")}function i(a){return(a?"</":"<")+"tr>"}function j(a){return"<td>"+a+"</td>"}function k(a){return"<th>"+a+"</th>"}var l="",m=new a({doc:!0});b(g(1,f(m.type,"#"+m.type)));try{b(m.doc)}catch(n){console.log(n)}for(o in m.subComponents){b(g(2,"Sub components"));break}for(var o in m.subComponents){var p=m.subComponents[o].type;b(_sub+d()),b(f("["+p+"]","#"+p)),b(c())}b(g(2,"Attributes")),b(h(0,"docTable")),b(i()),b(k("Name")),b(k("Type")),b(k("Values")),b(k("Description")),b(i(1));for(var q in m.attributes){b(i());var r=m.attributes[q];b(j(e(q))),b(j(r.type));var s="",t=m.attributes[q].values;if(t){if(Sfera.Utils.isFunction(t))try{t=t()}catch(n){t=[]}if(Sfera.Utils.isArray(t)){for(;s.length<35;)s+=" ";s+="<"+t.join("|")+">"}}b(j(s)),b(j(r.doc?r.doc:"")),b(i(1))}return b(h(1)),b('<link rel="stylesheet" href="css/style.css">'),l}this.id="dv",this.open=!1,this.fontSize=12,this.e=document.getElementById("docViewer");var d=document.getElementById("dv_toolbar"),e=document.getElementById("dv_docPanel");document.getElementById("dv_editorHeaderLabel"),this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",b(),this.adjustLayout()},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,g=a-c;d.style.left=c-1+"px",d.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),k=a-3*j-4*i-k;var g=a-2*i-2*j;e.style.left=j+"px",e.style.top=f+j+"px",e.style.width=g+"px",e.style.height=l+"px"}},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorE.style.fontSize=this.fontSize+"px"},a()},Sfera.Manager.Apps.FileManager=function(){function b(){r.onLoaded=j,r.onAuthenticate=function(a){fileManager.onUploadProgressError(),showPin(a)},r.onNoAccess=function(){fileManager.onUploadProgressError(),manager.showErrorPopup("No access")},r.onError=La.onUploadProgressError,Sfera.Device.iOS&&(E.style.display="none",K.style.display="none"),s="meh",La.toggleSelMode(""),"draggable"in document.createElement("span")&&(C.ondragover=m,C.ondragend=m,C.ondragleave=o,C.ondrop=l,I.ondragover=m,I.ondragend=m,I.ondragleave=o,I.ondrop=l)}function c(){for(var a=La.popupMode?La.popupData:La,b=La.popupMode?I:C,c=a.currentFolder,d='<img src="/manager/images/miniiconopen.png" class="openIcon">',e=La.popupMode?440:La.dirsPanelWidth,f=0;f<b.childNodes.length;f++){var g=b.childNodes[f],h=La.canOpen(f),i=c.sub[f].name,j="",k="";for(g.childNodes[1].innerHTML=i+(h?d:"");e-g.childNodes[1].offsetWidth<260&&(j||(j=i.substr(0,Math.round(i.length/2)),k=i.substr(j.length)),j=j.substr(0,j.length-1),k=k.substr(1),""!=j&&""!=k);)g.childNodes[1].innerHTML=j+"..."+k+(h?d:"")}}function d(){var a=this.popupMode?I:C;a.scrollHeight>a.clientHeight,La.popupMode?H:A}function e(a,b,c,d){if(!a){var e=La.currentFile;c=e.split("/"),b=c.pop();var f=b.split(".");d=f[f.length-1]}return a||"events.txt"!=b?c&&2==c.length&&"plugins"==c[0]&&"events.txt"==b?!0:!(!c||"events"!=c[0]||"txt"!=d):!0}function f(a){if(u=null,null!=a){t=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),t.push(c);t.push(a),files.load("copyfiles",t)}else files.load("copyfilesoverwrite",t)}function g(a){if(t=null,null!=a){u=[];for(var b,c,d=0;d<La.selectedItems.length;d++)b=La.selectedItems[d],c=La.currentFolder.sub[b].name,La.currentPath&&(c=La.currentPath+"/"+c),u.push(c);u.push(a),files.load("movefiles",u)}else files.load("movefilesoverwrite",u)}function h(a){var b,c,d=La.popupMode?La.popupData:La,e=(new Date).getTime()+"";if(v={id:e.substr(5),files:[],path:d.currentPath},a){v.size=0,v.data=[];for(var f=0;f<a.length;f++)v.data.push(a[f]),b=a[f].name,c=a[f].size,v.files.push({name:b,size:c}),v.size+=c}else{if(b=Ka.value,!b)return;b=b.split("\\").pop(),v.files=[{name:b,size:null}],v.size=null}for(var f=0;f<v.files.length;f++)for(var g=0;g<d.currentFolder.sub.length;g++)if(v.files[f].name==d.currentFolder.sub[g].name)return void manager.openPopup("uploadoverwrite",!0);La.confirmUpload()}function i(a){if(!x)return!1;if(!v.data)return!1;p=new Sfera.Net.Request({method:"POST"}),p.onError=function(a){if(La.onUploadProgressError(),a==p.ERROR_FORBIDDEN){var b=this.getResponseJSON();manager.showErrorPopup("Error uploading: "+b.error)}},p.onLoaded=function(){manager.showNotice("upload finished")},p.onProgress=j,p.addData("path",v.path),a&&p.addData("force","true");for(var b=0;b<v.data.length;b++)p.addData("file",v.data[b]);return p.open("/api/files/upload"),!0}function j(a){La.uploading&&!v.started&&(v.started=!0,La.open&&La.currentPath==v.path&&(La.popupMode?(La.popupMode=!1,La.showFolder(),La.popupMode=!0):La.showFolder())),v.progress=a.loaded;var b=a.loaded/a.total*100,c=v.size;100!=b?!La.popupMode&&La.currentPath==v.path&&-1!=v.index&&C.childNodes[v.index]&&(C.childNodes[v.index].childNodes[3].innerHTML=c?manager.formatFS(Math.round(c*b/100)):""):La.uploading&&(La.uploading=!1,manager.showNotice("upload finished"),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(w={path:v.path,name:v.name},La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),manager.closePopup()),0!=b&&(Da.style.display="",Ha.style.display="",Da.style.width=Math.round(238*b/100)+"px",Ha.style.width=Math.round(174*b/100)+"px"),Ea.innerHTML=Ia.innerHTML=Math.round(100*b)/100+"%";var d="error"!=b?Math.round(c*b/100):0;if(Fa.innerHTML=Ja.innerHTML=c?manager.formatFS(d)+"/"+manager.formatFS(c):"",0!=b&&v.files.length>1){for(var e=0,f=0;f<v.files.length&&(e+=v.files[f].size,!(e>=d));f++);var g="Uploading";g+=" ("+(f+1)+"/"+v.files.length+")",g+=": "+v.files[f].name,Ca.innerHTML=Ga.innerHTML=g}}function l(a){return this.className="fm_dirsContent",a&&a.dataTransfer?(a.stopPropagation(),a.preventDefault(),void h(a.dataTransfer.files)):!1}function m(a){try{a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}catch(b){}return this.className="fm_dirsContent hover",!1}function o(){return this.className="fm_dirsContent",!1}this.id="fm",this.open=!1;var p,q=!1,r=new Sfera.Net.Request;this.rootPath="",this.currentPath="",this.currentFile="",this.currentFolder=null,this.folderTs=0,this.filesInFolder=0,this.filter=null,this.selectedItem=-1,this.selectedItems=[],this.itemButtons=[],this.pathButtons=[];var s,t=[],u=[];this.dirsPanelWidth=0,this.popupMode=!1,this.popupData={currentPath:"",currentFile:"",currentFolder:null,folderTs:0,filter:null,replace:[],rootPath:"",defaultPath:"",selectedItem:-1},this.uploadCheckInterval=null,this.logPreviewVisible=!1,this.uploading=!1,this.uploadProgressVisible=!1;var v={};this.uploadDoneTimeout=null;var w,x=!!window.FormData;this.e=document.getElementById("fileManager");var y=document.getElementById("fm_dirsPath"),z=document.getElementById("fm_dirsPPath"),A=document.getElementById("fm_dirsHeader"),B=document.getElementById("fm_dirsPanel"),C=document.getElementById("fm_dirsContent"),D=document.getElementById("fm_dirsParentBt"),E=document.getElementById("fm_dirsUploadBt"),F=document.getElementById("fm_dirsNewFileBt"),G=document.getElementById("fm_dirsNewFolderBt"),H=document.getElementById("fm_dirsPHeader"),I=document.getElementById("fm_dirsPContent"),J=document.getElementById("fm_dirsPParentBt"),K=document.getElementById("fm_dirsPUploadBt"),L=document.getElementById("fm_dirsPNewFolderBt"),M=(document.getElementById("fm_dirsPConfirmBt"),document.getElementById("fm_detailsContent")),N=document.getElementById("fm_detailsPContent"),O=document.getElementById("fm_detailsPanel"),P=(document.getElementById("fm_detailsPPanel"),document.getElementById("fm_toolbar")),Q=document.getElementById("fm_dirsLoading"),R=document.getElementById("fm_dirsLoadingLabel"),S=document.getElementById("fm_dirsPLoading"),T=(document.getElementById("fm_detailsSel"),document.getElementById("fm_detailsSelN")),U=document.getElementById("fm_detailsTot"),V=document.getElementById("fm_detailsName"),W=document.getElementById("fm_detailsNameV"),X=document.getElementById("fm_detailsKind"),Y=document.getElementById("fm_detailsKindV"),Z=document.getElementById("fm_detailsSizeV"),$=(document.getElementById("fm_detailsPSel"),document.getElementById("fm_detailsPSelN")),_=document.getElementById("fm_detailsPTot"),aa=document.getElementById("fm_detailsPName"),ba=document.getElementById("fm_detailsPNameV"),ca=document.getElementById("fm_detailsPKind"),da=document.getElementById("fm_detailsPKindV"),ea=document.getElementById("fm_detailsPSizeV"),fa=document.getElementById("fm_detailsDirIcon"),ga=document.getElementById("fm_detailsFileIcon"),ha=document.getElementById("fm_detailsFilesIcon"),ia=document.getElementById("fm_detailsTextPreview"),ja=document.getElementById("fm_detailsFileIconOver"),ka=document.getElementById("fm_detailsImgPreview"),la=document.getElementById("fm_detailsPDirIcon"),ma=document.getElementById("fm_detailsPFileIcon"),na=document.getElementById("fm_detailsPFilesIcon"),oa=document.getElementById("fm_detailsPTextPreview"),pa=document.getElementById("fm_detailsPFileIconOver"),qa=document.getElementById("fm_detailsPImgPreview"),ra=document.getElementById("fm_detailsBtOpenFolder"),sa=document.getElementById("fm_detailsBtEdit"),ta=document.getElementById("fm_detailsBtOpenVE"),ua=document.getElementById("fm_detailsBtDelete"),va=document.getElementById("fm_detailsBtRestart"),wa=document.getElementById("fm_detailsBtMove"),xa=document.getElementById("fm_detailsBtDuplicate"),ya=document.getElementById("fm_detailsBtRename"),za=document.getElementById("fm_detailsBtDownload"),Aa=document.getElementById("fm_uploadProgressPanel"),Ba=document.getElementById("fm_uploadContent"),Ca=document.getElementById("fm_uploadFileName"),Da=document.getElementById("fm_uploadBar"),Ea=document.getElementById("fm_uploadProgress"),Fa=document.getElementById("fm_uploadBytes"),Ga=document.getElementById("fm_uploadPFileName"),Ha=document.getElementById("fm_uploadPBar"),Ia=document.getElementById("fm_uploadPProgress"),Ja=document.getElementById("fm_uploadPBytes"),Ka=document.getElementById("fm_uploadFileInput"),La=this;this.start=function(a){if(manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),a&&a.sel){var b=a.sel.split("/");w={name:b.pop(),path:b.join("/")}}q?(this.browseTo(this.currentPath),this.logPreviewVisible&&logViewer.startPreview(5)):(q=!0,this.browseTo("")),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),"key"==s&&La.toggleSelMode(""),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,e=0,f=36,g=a-e;P.style.left=e-1+"px",P.style.width=g+1+"px";var h=1,i=5+h,j=7,k=Math.round((a-3*j-4*i)/2),l=b-f-2*i-2*j;340>k&&(k=340),this.dirsPanelWidth=k;var m=0,n=140,o=k+2*i,m=70,p=l;this.logPreviewVisible&&(p-=n+j);var q=p;this.uploadProgressVisible&&(p-=m+2*i+j),B.style.left=j+"px",B.style.top=f+j+"px",B.style.width=k+"px",B.style.height=l+"px",Aa.style.left=O.style.left=2*j+2*i+k+"px",O.style.top=f+j+"px",k=a-3*j-4*i-k,Aa.style.width=O.style.width=k+"px",O.style.height=p+"px",Aa.style.height=m+"px",Aa.style.top=f+j+2*i+j+p+"px",C.style.height=b-144-i+"px",Q.style.height=b-144-i+"px",R.style.left=Math.round((C.offsetWidth-70)/2)+"px",Ba.style.left=Math.round((k-250)/2)+"px",M.style.left=Math.round((k-360)/2)+"px";var r=(O.offsetHeight-M.offsetHeight)/2-30;r=Math.round(40>r?r:40),M.style.top=r+"px";var g=a-2*i-2*j;if(this.logPreviewVisible){var s=f+j+q+2*i+j;logViewer.panelShape.y=s,logViewer.panelShape.x=O.offsetLeft,logViewer.panelShape.width=o,logViewer.panelShape.height=n,logViewer.adjustLayout()}c(),d()}},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.showLoading=function(a){var b=this.popupMode?S:Q;b.style.display=a?"inline":"none",this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F},this.browseTo=function(a){var b=this.popupMode?this.popupData:this;b.currentPath!=a&&(b.currentPath=a,b.currentFolder=null,this.selectItem(-1)),this.showFolderSel(),this.showLoading(!0),files.load("list",a),this.updatePath()},this.parentFolder=function(){var a=this.popupMode?this.popupData:this;if(a.currentPath){var b=a.currentPath.split("/");b.pop(),this.browseTo(b.join("/"))}},this.showFolder=function(a){var b=this.popupMode?this.popupData:this,e=this.popupMode?I:C,f=this.popupMode?J:D,g=(this.popupMode?K:E,this.popupMode?L:G,this.popupMode?null:F,0);if(a?(b.currentFolder=a,b.folderTs=0,b.filesInFolder=a.sub&&"?"!=a.sub?a.sub.length:0):(a=b.currentFolder,g=e.scrollTop),a){if(this.open&&this.uploading&&v.files&&v.files.length&&this.currentPath==v.path){var h,i,j,k,l;for(k=0;k<v.files.length;k++){for(ufp=-1,h=v.files[k],i=h.name,l={name:h.name,size:h.size,lastModified:"-",upload:!0},j=0;j<a.sub.length;j++){if(i==a.sub[j].name){ufp=j,a.sub[j]=l;break}if(i.toLowerCase()<a.sub[j].name.toLowerCase()){ufp=j,a.sub.splice(j,0,l);break}}-1==ufp&&(ufp=0,a.sub.push(l)),h.index=ufp}}if(b.filter)for(var m=b.currentPath?b.currentPath+"/":"",j=0;j<a.sub.length;j++)(!a.sub[j].sub||b.filter.path&&b.filter.path.test(m+a.sub[j].name))&&(a.sub[j].sub||b.filter.file&&b.filter.file.test(m+a.sub[j].name))||(a.sub.splice(j,1),j--);e.innerHTML="";var n,o;this.itemButtons=[];for(var j=0;j<a.sub.length;j++){if(a.sub[j].sub)o='<div class="icon"><img src="/manager/images/bticonfolder.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+manager.formatDate(a.sub[j].lastModified)+"</div>"),o+='<div class="size"></div>';else{var p=this.canEdit(j)?"bticontextfile":"bticonfile";o='<div class="icon"><img src="/manager/images/'+p+'.png" width="16" height="16" onmousedown="return false;"></div>',o+='<div class="name"></div>',this.popupMode||(o+='<div class="modified">'+(a.sub[j].upload?"-":manager.formatDate(a.sub[j].lastModified))+"</div>"),o+='<div class="size">'+manager.formatFS(a.sub[j].size)+"</div>"}n=document.createElement("div"),n.innerHTML=o,n.className="fileItem mLineButton"+(a.sub[j].upload?" disabled":"")+(-1!=b.selectedItems.indexOf(j)?" selected":""),this.itemButtons.push(new Sfera.UI.Button(n,{onclick:"fileManager.selectItem("+j+")"})),e.appendChild(n)}c()}else e.innerHTML='<div class="fileItem mLineButton">Path not found.</div>';if(d(),f.style.display=b.currentPath!=b.rootPath?"inline":"none",
e.scrollTop=g,this.showLoading(!1),!this.popupMode&&this.selectedItem&&this.showDetails(),w){if(w.path==b.currentPath)for(var j=0;j<a.sub.length;j++)if(w.name==a.sub[j].name){this.selectItem(j);break}w=null}},this.showDetails=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?N:M,c=this.popupMode?oa:ia,d=this.popupMode?la:fa,e=this.popupMode?ma:ga,f=this.popupMode?na:ha,g=this.popupMode?pa:ja,h=this.popupMode?qa:ka,i=this.popupMode?$:T,j=this.popupMode?_:U,l=this.popupMode?aa:V,m=this.popupMode?ba:W,n=this.popupMode?ca:X,o=this.popupMode?da:Y,p=this.popupMode?ea:Z;if(-1==a.selectedItem)c.innerHTML="",h.style.display="none",h.style.visibility="hidden";else{var q=a.selectedItems.length>1,r=a.selectedItem,s=a.currentFolder.sub[r].name,t=q?"multi":a.currentFolder.sub[r].sub?"d":"f",u=a.currentPath+(a.currentPath?"/":"")+s,v=/^www\/([^\/]*\/)?img\/[^\.]*\.(gif|jpe?g|png)$/,w=0;for(k=0;k<a.selectedItems.length;k++)w+=a.currentFolder.sub[a.selectedItems[k]].size;var x=!q&&"f"==t&&v.test(u)&&3e5>w;if(d.style.display="d"!=t||x?"none":"inline",e.style.display="f"!=t||x?"none":"inline",f.style.display=q?"inline":"none",c.style.display="f"==t&&!x&&this.canEdit(r)?"inline":"none",g.style.display="f"!=t||x?"none":"inline",h.style.display=x?"inline":"none",h.style.visibility="hidden",x?h.src="/x/files?gv*"+files.encodeFileName(a.currentFile):h.src="/manager/images/empty.png",c.innerHTML="","f"==t&&this.canEdit(r)&&files.load("gettextpreview",u),i.innerHTML=a.selectedItems.length,j.innerHTML=a.filesInFolder,l.style.display=q?"none":"block",m.innerHTML=q?"":a.currentFolder.sub[r].name,n.style.display=q?"none":"block",o.innerHTML=q?"":this.getFileKind(u,t),p.innerHTML="d"==t?"-":manager.formatFS(w),!this.popupMode){var y=!1;if(""==a.currentPath)for(k=0;k<a.selectedItems.length;k++)if(s=a.currentFolder.sub[a.selectedItems[k]].name,"hsyco.jar"==s||"hsyco.ini"==s||"access.ini"==s){y=!0;break}ra.style.display="d"==t?"inline":"none",sa.style.display=!q&&this.canEdit(r)?"inline":"none",ta.style.display=q||-1==u.search(/www\/[^\/]+\/index.hsm/)?"none":"inline",ua.style.display=y?"none":"inline",va.style.display=q||a.currentPath+a.currentFile!="hsyco.jar"?"none":"inline",wa.style.display=y?"none":"inline",xa.style.display=q?"none":"inline",ya.style.display=q||y?"none":"inline",za.style.display="inline"}}b.style.visibility=a.selectedItem>=0?"visible":"hidden"},this.showFolderSel=function(){for(var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=0;c<b.childNodes.length;c++)this.itemButtons[c].setAttribute("selected",-1!=a.selectedItems.indexOf(c)),this.itemButtons[c].setAttribute("disabled",this.uploading&&v.index==c)},this.refreshFolder=function(a){var b=this.popupMode?this.popupData:this,c=this.popupMode?I:C,d=0;if(!b.currentFolder||(d=c.scrollTop,JSON.stringify(b.currentFolder)!=JSON.stringify(a))){for(var e,f,g=[],h=!1,i=0;i<b.selectedItems.length;i++)e=b.selectedItems[i],f=b.currentFolder.sub[e].name,g.push(f),!h&&(a.sub.length<=e||a.sub[e].name!=f)&&(h=!0);if(h&&this.selectItem(-1),this.showFolder(a),h){for(var j=[],i=0;i<a.sub.length;i++)-1!=g.indexOf(a.sub[i].name)&&j.push(i);if(j.length==g.length){var k=s;s="key";for(var i=0;i<j.length;i++)this.selectItem(j[i]);s=k}}c.scrollTop=d}},this.updatePath=function(){var b=this.popupMode?this.popupData:this;a=b.currentPath.split("/"),b.rootPath&&a.splice(0,b.rootPath.split("/").length);var c,d="",e=b.rootPath?b.rootPath:"Sfera Server",f=[b.rootPath];if(d+=" <span class='mTextButton "+(b.currentPath!=b.rootPath?"checked":"selected")+"'>"+e+"</span>",b.currentPath)for(c=0;c<a.length;c++)e=a[c],f.push((b.rootPath?"/":"")+e),d+="&nbsp;&raquo;&nbsp;<span class='mTextButton "+(c<a.length-1?"checked":"selected")+"'>"+e+"</span>";var b=this.popupMode?z:y;b.innerHTML=d,Sfera.UI.destroyButtons(this.pathButtons);var g=b.getElementsByTagName("SPAN");for(c=0;c<g.length;c++)this.pathButtons.push(new Sfera.UI.Button(g[c],{onclick:"fileManager.browseTo('"+f[c]+"')"}))},this.getFileKind=function(a,b){if("d"==b)return"Folder";var c=a.split("/"),d=c.pop(),f=c.join("/"),g=d.split("."),h=g[g.length-1];if(e(f,d,c,h))return"Events File";switch(h){case"txt":return"Plain Text";case"xml":return"XML Document";case"ini":return"Ini File";case"jar":return"Java JAR File";case"jpg":case"jpeg":case"gif":case"png":return"Image";case"avi":return"Video";case"log":return"Log File";case"css":return"CSS Stylesheet";case"hsc":return"HSC File";case"hsm":return"Project File";default:return"log"==g[g.length-2]?"Log File":"Document"}},this.canOpen=function(a){if(this.popupMode)return!0;var b=this,c=(b.currentFolder.sub[a].name,b.currentFolder.sub[a].sub?"d":"t");return"d"==c?!0:this.canEdit(a)},this.canEdit=function(a){if(this.popupMode)return!1;var b=this.currentFolder.sub[a].name,c=this.currentFolder.sub[a].sub?"d":"f";if("d"==c)return!1;for(var d=(this.currentFolder.sub[a].size,this.currentPath+(this.currentPath?"/":"")+b,b.split(".")),e=d.length>1?d.pop():"",f=["jpg","jpeg","png","apng","gif","bmp","exe","jar"],a=0;a<f.length;a++)if(e==f[a])return!1;return!0},this.selectItem=function(a){var b=this.popupMode?this.popupData:this,c=s&&!this.popupMode,d=!1;if(null==a&&(a=b.selectedItem),a>=0){if(this.uploading&&v.index==a)return;var e=b.currentFolder.sub[a].name,f=b.currentFolder.sub[a].sub?"d":"f",g=b.currentPath+(b.currentPath?"/":"")+e;if(b.selectedItem!=a||c){if(c){var h=b.selectedItems.indexOf(a);-1==h?(b.selectedItem=a,b.selectedItems.push(a)):(b.selectedItems.splice(h,1),b.selectedItem=b.selectedItems.length?b.selectedItems.last():-1)}else b.selectedItem=a,b.selectedItems=[a],b.currentFile=g;this.popupMode&&(d=b.selectedItems.length&&"f"==f||b.filter&&b.filter.folder),this.showDetails()}else if(b.selectedItems=[b.selectedItem],"d"==f)this.browseTo(b.currentPath+(b.currentPath?"/":"")+e);else{if(this.popupMode)return void this.confirmChooseFilePopup();this.canEdit(a)&&this.openEditor()}}else b.selectedItem=-1,b.selectedItems=[],this.popupMode&&(d=b.filter&&b.filter.folder);-1==b.selectedItem&&(b.currentFile="",this.showDetails()),this.showFolderSel()},this.selectNext=function(){var a=this.popupMode?this.popupData:this,b=this.popupMode?I:C,c=a.selectedItem+1;c>=b.childNodes.length||this.selectItem(c)},this.selectPrev=function(){var a=this.popupMode?this.popupData:this,b=a.selectedItem-1;0>b||this.selectItem(b)},this.toggleSelMode=function(a){var b=s;s=a?a:""===a?null:s?null:"bt",b!=s&&(document.getElementById("selectButtonFm").getElementsByTagName("img")[0].style.display=s?"inline":"none",document.getElementById("selectButtonFm").getElementsByTagName("img")[1].style.display=s?"none":"inline")},this.newFolder=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(a.currentPath&&(b=a.currentPath+"/"+b),manager.closePopup(),manager.showLoadingPopup(),files.load("newfolder",b))},this.deleteItems=function(){this.popupMode?this.popupData:this,manager.closePopup(),manager.showLoadingPopup(),delData=[];for(var a,b,c=0;c<La.selectedItems.length;c++)a=La.selectedItems[c],b=La.currentFolder.sub[a].name,La.currentPath&&(b=La.currentPath+"/"+b),delData.push(b);files.load("deletefile",delData),this.selectItem(-1)},this.newFile=function(){var a=La.popupMode?La.popupData:La,b=(La.popupMode,manager.cPopup.data.input.n.value);b&&(manager.closePopup(),La.currentFile=a.currentPath+(a.currentPath?"/":"")+b,La.openEditor(!0))},this.openEditor=function(a){var b=La.popupMode?La.popupData:La;manager.switchApp("te",{from:"fm",open:b.currentFile,isNew:a})},this.renameFile=function(){var a=La.popupMode?La.popupData:La,b=manager.cPopup.data.input.n.value;if(b){var c=a.currentPath?a.currentPath+"/":"";manager.closePopup(),w={path:a.currentPath,name:b},files.load("renamefile",[fileManager.currentFile,c+b])}},this.openInProjectEditor=function(){var a=this.popupMode?this.popupData:this;projectEditor.toLoad=a.currentPath.split("/").pop(),manager.switchApp("pe")},this.updateTextPreview=function(a){var b=this.popupMode?this.popupData:this;a=a.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;"),a="<pre><div class='title'>"+b.currentFile.split("/").pop()+"</div>"+a+"</pre>",ia.innerHTML=a},this.downloadFiles=function(){for(var a=this.popupMode?this.popupData:this,b="."+(new Date).getTime(),c="/api/files/download?",d=0;d<this.selectedItems.length;d++)k=this.selectedItems[d],n=this.currentFolder.sub[k].name,this.currentPath&&(n=La.currentPath+"/"+n),c+=(d?"&":"")+"path="+this.encodeFileName(n);c+="&ts="+b,document.getElementById("downloadTarget").src=c,a.currentFolder.sub[a.selectedItem].sub&&manager.showNotice("Download requested, please wait...")},this.downloadBackup=function(){var a="."+(new Date).getTime();document.getElementById("downloadTarget").src="/api/files/download?path=.&ts="+a,manager.showNotice("Backup requested, please wait..."),manager.closeToolbarPopup()},this.openNewFolderPopup=function(){this.popupMode,manager.openPopup("newfolder",!0)},this.openNewFilePopup=function(){manager.openPopup("newfile",!0)},this.openRenameFilePopup=function(){manager.openPopup("renamefile",!0),manager.cPopup.data.input.n.value=this.currentFolder.sub[this.selectedItem].name},this.copyItems=function(){La.openChooseFilePopup(f,"folder")},this.moveItems=function(a){La.openChooseFilePopup(g,"folder")},this.confirmOverwrite=function(){manager.closePopup(),t?f():g()},this.duplicateFile=function(){var a=La.selectedItems[0],b=La.currentFolder.sub[a].name,c=La.currentPath?La.currentPath+"/":"",d=b.split("."),e=this.canEdit(a);d[d.length>1&&e?d.length-2:0]+="_copy";var f=d.join(".");w={path:c,name:f},files.load("duplicatefile",[c+b,c+f])},this.openUploadPopup=function(){this.popupMode?this.popupData:this,this.popupMode,this.uploading?manager.openPopup("uploadingfile",!0):manager.openPopup("uploadfile",!0)},this.uploadFile=function(){var a;Ka.files&&x&&(a=Ka.files),h(a)},this.confirmUpload=function(a){return v.data||console.log("ERROR"),i(a)?(La.showUploadProgress(!0),La.uploading=!0,La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null),manager.cPopup&&"uploadoverwrite"==manager.cPopup.id&&manager.closePopup(),manager.cPopup&&"uploadfile"==manager.cPopup.id&&manager.closePopup(),void(La.popupMode&&manager.openPopup("uploadingfile",!1))):void La.onUploadProgressError()},this.showUploadProgress=function(a){if(La.uploadProgressVisible=a,Aa.style.display=a?"inline":"none",La.adjustLayout(),Ca.innerHTML="",Ea.innerHTML="",Fa.innerHTML="",Da.style.display="none",Ga.innerHTML="&nbsp;",Ia.innerHTML="&nbsp;",Ja.innerHTML="&nbsp;",Ha.style.display="none",a){var b="Uploading";v.files.length>1&&(b+=" (1/"+v.files.length+")"),b+=": "+v.files[0].name,Ca.innerHTML=Ga.innerHTML=b}!a&&La.uploadDoneTimeout&&(clearTimeout(La.uploadDoneTimeout),La.uploadDoneTimeout=null)},this.onUploadProgressError=function(){if(Ea.innerHTML=Ia.innerHTML="error",p)try{req.abort()}catch(a){}var b="file"+(v.files.length>1?"s":"");manager.showNotice("error uploading "+b),La.uploadDoneTimeout=setTimeout(La.showUploadProgress,5e3),!La.popupMode&&La.open&&La.currentPath==v.path?La.browseTo(v.path):La.popupMode&&(La.browseTo(v.path),La.currentPath==v.path&&La.open&&(La.popupMode=!1,La.browseTo(La.currentPath),La.popupMode=!0)),La.uploading=!1,manager.closePopup()},this.cancelUpload=function(){this.uploading=!1,r.stop(),this.showUploadProgress(!1),this.popupMode||this.currentPath!=v.path||this.browseTo(this.currentPath),v={},manager.showNotice("upload canceled"),manager.closePopup()},this.openChooseFilePopup=function(a,b){if(this.popupMode=!0,manager.openPopup("choosefile",!0,function(){fileManager.popupMode=!1}),a){switch(this.popupData.onChoose=a,b){case"img":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(jpe?g|gif|png)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:new RegExp(c),b:""}),this.popupData.filter.folder=!1;break;case"video":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose File",this.popupData.rootPath="www",this.popupData.defaultPath=this.popupData.currentPath?this.popupData.currentPath:"www/img",this.popupData.filter={};var c="^(www(/img(/.+)?";projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"|/"+project.name+"/img(/.+)?"),c+=")?)$",this.popupData.filter.path=new RegExp(c),c="^(www(/img/",projectEditor.open&&project&&project.name&&(c+="|/"+project.name+"/img/"),c+=")).*.(mp4|webm|ogv)$",this.popupData.filter.file=new RegExp(c),this.popupData.replace=[],c=/(www\/([^\/]*\/)?img\/)/,this.popupData.replace.push({a:c,b:""}),c=/\.(mp4|webm|ogv)$/,this.popupData.replace.push({a:c,b:""}),this.popupData.filter.folder=!1;break;case"folder":manager.cPopup.contentE.getElementsByTagName("span")[0].innerHTML="Choose Destination",this.popupData.rootPath=this.rootPath,this.popupData.defaultPath=this.currentPath,this.popupData.filter={};var c=".";this.popupData.filter.path=new RegExp(c),this.popupData.filter.file=null,this.popupData.replace=[],this.popupData.filter.folder=!0}this.browseTo(this.popupData.defaultPath),this.selectItem(-1),K.style.display=this.popupData.filter.folder?"none":"inline"}this.focus()},this.confirmChooseFilePopup=function(){var a=La.popupData.currentFile;!a&&La.popupData.filter&&La.popupData.filter.folder&&(a=La.popupData.currentPath);for(var b=0;b<La.popupData.replace.length;b++)a=a.replace(La.popupData.replace[b].a,La.popupData.replace[b].b);La.popupData.onChoose(a),manager.closePopup()},this.onDirsClick=function(a,b){var c=window.event||a;if(c&&(c.target=c.target||c.srcElement),c&&c.target&&c.target==b){var d=c.offsetX?c.offsetX:c.layerX;if(null==d||30>d||B.offsetWidth-d<30)return;this.selectItem(-1)}},this.onList=function(a){this.editorOpen||this.selectItem(-1),this.showFolder(a);var b=this.popupMode?this.popupData:this,c=b.currentPath,d={action:"subscribe",files:c?c:".",tag:(new Date).getTime()};Sfera.Net.wsSend(JSON.stringify(d))},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(a.shiftKey&&!s&&La.toggleSelMode("key"),manager.cPopup&&"choosefile"!=manager.cPopup.id){if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}}else if(La.popupMode)switch(b){case 8:break;case 37:browser.preventDefault(a);break;case 38:browser.preventDefault(a),fileManager.selectPrev();break;case 39:browser.preventDefault(a);break;case 40:browser.preventDefault(a),fileManager.selectNext();break;case 13:browser.preventDefault(a);var d=fileManager.popupMode?fileManager.popupData:fileManager;d.selectedItem>=0&&fileManager.selectItem(d.selectedItem);break;case 90:}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),focusedElement||manager.deselect(),a.shiftKey||"key"!=s||La.toggleSelMode(""),!a.ctrlKey&&manager.hideQuickAppsPanel()},b()},Sfera.Manager.Apps.SystemConsole=function(){function a(){g.editor=ace.edit("sc_consoleText"),g.editor.setShowPrintMargin(!1),g.editor.setReadOnly(!0),g.editor.renderer.setShowGutter(!1)}this.id="sc",this.open=!1,this.fontSize=12,this.changed=!1,this.e=document.getElementById("systemConsole");var b=document.getElementById("sc_toolbar"),c=document.getElementById("sc_input"),d=document.getElementById("sc_outputPanel"),e=document.getElementById("sc_inputPanel"),f=document.getElementById("sc_loading"),g=this,h=[];this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.focus(),this.open=!0},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus(),c.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,g=manager.viewportHeight,h=0,i=36,j=a-h;b.style.left=h-1+"px",b.style.width=j+1+"px";var k=1,l=5+k,m=7,n=Math.round((a-3*m-4*l)/2),o=g-i-2*l-2*m;340>n&&(n=340),n=a-3*m-4*l-n;var p=30,q=a-2*l-2*m,r=o-2*m-p;d.style.left=m+"px",d.style.top=i+m+"px",d.style.width=q+"px",d.style.height=r+"px",e.style.width=q+"px",e.style.height=p+"px",e.style.left=m+"px",e.style.bottom=m+"px",c.style.width=j-125+"px",f.style.left=Math.round((j-70)/2)+"px"}},this.send=function(){v=c.value,"clear"==v?this.editor.setValue(""):Sfera.Net.sendConsole({command:v}),h.push(v),historyPos=h.length,c.value="","clear"!=v&&this.output("> "+v)},this.output=function(a){var b=this.editor.session;b.insert({row:b.getLength(),column:0},"\n"+a),this.editor.gotoLine(b.getLength())},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,editorTextE.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var d;if(a.target?d=a.target:a.srcElement&&(d=a.srcElement),3==d.nodeType&&(d=d.parentNode),8==b&&!(d&&d.tagName&&d.type&&/(password)|(text)|(file)/.test(d.type.toLowerCase())||"textarea"==d.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),13==b&&!a.ctrlKey&&!a.shiftKey)return void g.send();if(38==b||40==b){38==b?historyPos--:40==b&&historyPos++,historyPos<0&&(historyPos=0),historyPos>h.length&&(historyPos=h.length);var e="";historyPos<h.length&&(e=h[historyPos]),c.focus(),c.value=e,c.selectionStart=c.selectionEnd=e.length}return manager.cPopup&&manager.cPopup.closeBt&&27==b?(manager.closePopup(),void browser.preventDefault(a)):void 0},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.showLoading=function(a){a?(editorTextE.style.display="none",editorLoadingE.style.display="inline"):(toolbarSaveBtE.style.display="inline",editorTextE.style.display="inline",editorLoadingE.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),updateTitle()},a()},Sfera.Manager.Apps.TextEditor=function(){function a(){j.style.display="none",k.editor=ace.edit("te_editorText"),k.editor.setShowPrintMargin(!1),k.editor.getSession().setMode("ace/mode/javascript"),k.editor.getSession().on("change",function(a){k.changed=!0,c()})}function b(){}function c(){f.innerHTML=(k.changed?"* ":"")+k.currentFile}this.id="te",this.open=!1,this.closing=!1,this.currentFile="",this.fontSize=12,this.changed=!1,this.returnToFM=!1,this.e=document.getElementById("textEditor");var d=document.getElementById("te_toolbar"),e=document.getElementById("te_editorPanel"),f=document.getElementById("te_editorHeaderLabel"),g=document.getElementById("te_editorText"),h=document.getElementById("te_editorLoading"),i=document.getElementById("te_toolbarSaveBt"),j=document.getElementById("te_editorModeBt"),k=this,l=!1;this.start=function(a){manager.hideOtherApps(this),this.e.style.display="inline",this.adjustLayout(),this.showLoading(!1),this.focus(),this.open=!0,this.closing=!1,a&&("fm"==a.from&&(this.returnToFM=!0),a.open&&(a.isNew?this.newFile(a.open):this.openFile(a.open)))},this.hide=function(){this.e.style.display="none",manager.focus(),this.open=!1},this.focus=function(){document.onkeydown=this.onKeyDown,document.onkeyup=this.onKeyUp,window.focus&&window.focus()},this.adjustLayout=function(){if(manager.viewportWidth&&manager.viewportHeight){var a=manager.viewportWidth,b=manager.viewportHeight,c=0,f=36,i=a-c;d.style.left=c-1+"px",d.style.width=i+1+"px";var j=1,k=5+j,l=7,m=Math.round((a-3*l-4*k)/2),n=b-f-2*k-2*l;340>m&&(m=340),m=a-3*l-4*k-m;var i=a-2*k-2*l;e.style.left=l+"px",e.style.top=f+l+"px",e.style.width=i+"px",e.style.height=n+"px",g.style.width=i+"px",g.style.height=n-30+"px",h.style.left=Math.round((i-70)/2)+"px"}},this.toggleComment=function(){},this.setFontSize=function(a){a?this.fontSize++:this.fontSize--,g.style.fontSize=this.fontSize+"px"},this.onWSMessage=function(a){if(console.log(a),a&&a.files){var b=this.popupMode?this.popupData:this,c=b.currentPath;""==c&&(c=".");for(var d in a.files)if(d==c)return void files.load("refresh_list",d)}},this.onKeyDown=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which);var c;if(a.target?c=a.target:a.srcElement&&(c=a.srcElement),3==c.nodeType&&(c=c.parentNode),8==b&&!(c&&c.tagName&&c.type&&/(password)|(text)|(file)/.test(c.type.toLowerCase())||"textarea"==c.tagName.toLowerCase()))return browser.preventDefault(a),!1;if(a.ctrlKey&&a.shiftKey&&67==b)return this.toggleColorMode(),manager.hideQuickAppsPanel(!0),!1;if(16==b&&a.ctrlKey&&manager.showQuickAppsPanel(),manager.cPopup&&manager.cPopup.closeBt&&27==b)return manager.closePopup(),void browser.preventDefault(a);if(!manager.cPopup||"choosefile"==manager.cPopup.id)return 83!=b||!a.ctrlKey&&!a.metaKey||manager.cPopup?void 0:(browser.preventDefault(a),void textEditor.save());if(13==b)switch(manager.cPopup.id){case"newfolder":focusedElement==manager.cPopup.data.input.n&&fileManager.newFolder();break;case"newfile":focusedElement==manager.cPopup.data.input.n&&fileManager.newFile();break;case"renamefile":focusedElement==manager.cPopup.data.input.n&&fileManager.renameFile()}},this.onKeyUp=function(a){if(!a)var a=window.event;var b;a.keyCode?b=a.keyCode:a.which&&(b=a.which),!a.ctrlKey&&manager.hideQuickAppsPanel()},this.openFile=function(a){this.currentFile=a,this.showLoading(!0),files.load("readfile",a)},this.newFile=function(a){this.currentFile=a,this.changed=!0,this.updateEditor("")},this.close=function(a){return this.changed&&null==a?void manager.openPopup("closeeditor",!0):(b(),a?void this.saveFile(!0):(manager.closePopup(),this.editor.setValue(""),this.editor.resize(!0),this.returnToFM=!1,this.closing=!0,manager.switchApp("fm",{sel:this.currentFile}),this.changed=!1,this.currentFile="",void c()))},this.showLoading=function(a){a?(g.style.display="none",h.style.display="inline"):(i.style.display="inline",g.style.display="inline",h.style.display="none")},this.updateEditor=function(a){this.showLoading(!1),this.editor.setValue(a),this.editor.clearSelection(),this.editor.moveCursorTo(0,0),this.editor.getSession().setScrollTop(0),this.editor.focus(),c()},this.onFileRead=function(a){this.updateEditor(a),this.changed=!1,c()},this.onFileSaved=function(a){this.changed=!1,c(),manager.closePopup(),r.error?manager.showNotice("error saving <b>"+files.resID+"</b>"):(manager.showNotice("<b>"+files.resID+"</b> saved"),manager.closePopup()),this.editor.focus(),l&&(l=!1,this.close())},this.saveFile=function(a){manager.showSavingPopup(),files.load("writefile",[this.currentFile,this.editor.getValue()]),l=a},a()};